<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shangnantea.mapper.TeaMapper">
    
    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.shangnantea.model.entity.tea.Tea">
        <id column="id" property="id" jdbcType="VARCHAR"/>
        <result column="name" property="name" jdbcType="VARCHAR"/>
        <result column="shop_id" property="shopId" jdbcType="VARCHAR"/>
        <result column="category_id" property="categoryId" jdbcType="INTEGER"/>
        <result column="price" property="price" jdbcType="DECIMAL"/>
        <result column="description" property="description" jdbcType="VARCHAR"/>
        <result column="detail" property="detail" jdbcType="VARCHAR"/>
        <result column="origin" property="origin" jdbcType="VARCHAR"/>
        <result column="stock" property="stock" jdbcType="INTEGER"/>
        <result column="sales" property="sales" jdbcType="INTEGER"/>
        <result column="main_image" property="mainImage" jdbcType="VARCHAR"/>
        <result column="status" property="status" jdbcType="INTEGER"/>
        <result column="is_deleted" property="isDeleted" jdbcType="INTEGER"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
    </resultMap>
    
    <!-- 公共列 -->
    <sql id="Base_Column_List">
        id, name, shop_id, category_id, price, description, detail, origin, 
        stock, sales, main_image, status, is_deleted, create_time, update_time
    </sql>
    
    <!-- 根据ID查询茶叶 -->
    <select id="selectById" resultMap="BaseResultMap" parameterType="java.lang.String">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM teas
        WHERE id = #{id,jdbcType=VARCHAR} AND is_deleted = 0
    </select>
    
    <!-- 根据店铺ID查询茶叶列表 -->
    <select id="selectByShopId" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM teas
        WHERE shop_id = #{shopId,jdbcType=VARCHAR} 
          AND is_deleted = 0 
          AND status = 1
        ORDER BY create_time DESC
        LIMIT #{offset}, #{pageSize}
    </select>
    
    <!-- 统计店铺茶叶总数 -->
    <select id="countByShopId" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM teas
        WHERE shop_id = #{shopId,jdbcType=VARCHAR} 
          AND is_deleted = 0 
          AND status = 1
    </select>
    
    <!-- 根据分类ID查询茶叶列表 -->
    <select id="selectByCategoryId" resultMap="BaseResultMap" parameterType="java.lang.Integer">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM teas
        WHERE category_id = #{categoryId,jdbcType=INTEGER} AND is_deleted = 0 AND status = 1
        ORDER BY sales DESC, create_time DESC
    </select>
    
    <!-- 查询热门茶叶列表 -->
    <select id="selectHotTeas" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM teas
        WHERE is_deleted = 0 AND status = 1
        ORDER BY sales DESC, create_time DESC
        LIMIT #{limit,jdbcType=INTEGER}
    </select>
    
    <!-- 查询最新茶叶列表 -->
    <select id="selectNewTeas" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM teas
        WHERE is_deleted = 0 AND status = 1
        ORDER BY create_time DESC
        LIMIT #{limit,jdbcType=INTEGER}
    </select>
    
    <!-- 搜索茶叶 -->
    <select id="searchTeas" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM teas
        <where>
            is_deleted = 0 AND status = 1
            <if test="keyword != null and keyword != ''">
                AND (name LIKE CONCAT('%', #{keyword}, '%') OR description LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="categoryId != null">
                AND category_id = #{categoryId,jdbcType=INTEGER}
            </if>
            <if test="minPrice != null">
                AND price &gt;= #{minPrice,jdbcType=DECIMAL}
            </if>
            <if test="maxPrice != null">
                AND price &lt;= #{maxPrice,jdbcType=DECIMAL}
            </if>
            <if test="origin != null and origin != ''">
                AND origin LIKE CONCAT('%', #{origin}, '%')
            </if>
        </where>
        <choose>
            <when test="orderBy == 'price' and orderDirection == 'asc'">
                ORDER BY price ASC
            </when>
            <when test="orderBy == 'price' and orderDirection == 'desc'">
                ORDER BY price DESC
            </when>
            <when test="orderBy == 'sales'">
                ORDER BY sales DESC
            </when>
            <when test="orderBy == 'create_time'">
                ORDER BY create_time DESC
            </when>
            <otherwise>
                ORDER BY sales DESC, create_time DESC
            </otherwise>
        </choose>
    </select>
    
    <!-- 分页查询茶叶列表（支持多条件筛选） -->
    <select id="selectTeasWithPage" resultMap="BaseResultMap" parameterType="java.util.Map">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM teas
        <where>
            is_deleted = 0
            <if test="status != null">
                AND status = #{status,jdbcType=INTEGER}
            </if>
            <if test="status == null">
                AND status = 1
            </if>
            <if test="keyword != null and keyword != ''">
                AND (name LIKE CONCAT('%', #{keyword}, '%') OR description LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="categoryId != null">
                AND category_id = #{categoryId,jdbcType=INTEGER}
            </if>
            <if test="shopId != null and shopId != ''">
                AND shop_id = #{shopId,jdbcType=VARCHAR}
            </if>
            <if test="priceMin != null">
                AND price &gt;= #{priceMin,jdbcType=DECIMAL}
            </if>
            <if test="priceMax != null">
                AND price &lt;= #{priceMax,jdbcType=DECIMAL}
            </if>
            <if test="origin != null and origin != ''">
                AND origin LIKE CONCAT('%', #{origin}, '%')
            </if>
        </where>
        <choose>
            <when test="sortBy == 'price' and sortOrder == 'asc'">
                ORDER BY price ASC
            </when>
            <when test="sortBy == 'price' and sortOrder == 'desc'">
                ORDER BY price DESC
            </when>
            <when test="sortBy == 'sales'">
                ORDER BY sales DESC
            </when>
            <when test="sortBy == 'rating'">
                ORDER BY (
                    SELECT COALESCE(AVG(rating), 0)
                    FROM tea_reviews
                    WHERE tea_id = teas.id
                ) DESC
            </when>
            <otherwise>
                ORDER BY sales DESC, create_time DESC
            </otherwise>
        </choose>
        LIMIT #{offset,jdbcType=INTEGER}, #{pageSize,jdbcType=INTEGER}
    </select>
    
    <!-- 统计符合条件的茶叶总数 -->
    <select id="countTeas" resultType="long" parameterType="java.util.Map">
        SELECT COUNT(*)
        FROM teas
        <where>
            is_deleted = 0
            <if test="status != null">
                AND status = #{status,jdbcType=INTEGER}
            </if>
            <if test="status == null">
                AND status = 1
            </if>
            <if test="keyword != null and keyword != ''">
                AND (name LIKE CONCAT('%', #{keyword}, '%') OR description LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="categoryId != null">
                AND category_id = #{categoryId,jdbcType=INTEGER}
            </if>
            <if test="shopId != null and shopId != ''">
                AND shop_id = #{shopId,jdbcType=VARCHAR}
            </if>
            <if test="priceMin != null">
                AND price &gt;= #{priceMin,jdbcType=DECIMAL}
            </if>
            <if test="priceMax != null">
                AND price &lt;= #{priceMax,jdbcType=DECIMAL}
            </if>
            <if test="origin != null and origin != ''">
                AND origin LIKE CONCAT('%', #{origin}, '%')
            </if>
        </where>
    </select>
    
    <!-- 插入茶叶 -->
    <insert id="insert" parameterType="com.shangnantea.model.entity.tea.Tea">
        INSERT INTO teas (
            id, name, shop_id, category_id, price, description, detail, origin, 
            stock, sales, main_image, status, is_deleted, create_time, update_time
        ) VALUES (
            #{id,jdbcType=VARCHAR}, 
            #{name,jdbcType=VARCHAR}, 
            #{shopId,jdbcType=VARCHAR}, 
            #{categoryId,jdbcType=INTEGER}, 
            #{price,jdbcType=DECIMAL}, 
            #{description,jdbcType=VARCHAR}, 
            #{detail,jdbcType=VARCHAR}, 
            #{origin,jdbcType=VARCHAR}, 
            #{stock,jdbcType=INTEGER}, 
            #{sales,jdbcType=INTEGER}, 
            #{mainImage,jdbcType=VARCHAR}, 
            #{status,jdbcType=INTEGER}, 
            #{isDeleted,jdbcType=INTEGER}, 
            #{createTime,jdbcType=TIMESTAMP}, 
            #{updateTime,jdbcType=TIMESTAMP}
        )
    </insert>
    
    <!-- 更新茶叶 -->
    <update id="update" parameterType="com.shangnantea.model.entity.tea.Tea">
        UPDATE teas
        <set>
            <if test="name != null">name = #{name,jdbcType=VARCHAR},</if>
            <if test="categoryId != null">category_id = #{categoryId,jdbcType=INTEGER},</if>
            <if test="price != null">price = #{price,jdbcType=DECIMAL},</if>
            <if test="description != null">description = #{description,jdbcType=VARCHAR},</if>
            <if test="detail != null">detail = #{detail,jdbcType=VARCHAR},</if>
            <if test="origin != null">origin = #{origin,jdbcType=VARCHAR},</if>
            <if test="stock != null">stock = #{stock,jdbcType=INTEGER},</if>
            <if test="sales != null">sales = #{sales,jdbcType=INTEGER},</if>
            <if test="mainImage != null">main_image = #{mainImage,jdbcType=VARCHAR},</if>
            <if test="status != null">status = #{status,jdbcType=INTEGER},</if>
            <if test="isDeleted != null">is_deleted = #{isDeleted,jdbcType=INTEGER},</if>
            update_time = now()
        </set>
        WHERE id = #{id,jdbcType=VARCHAR}
    </update>
    
    <!-- 更新库存和销量 -->
    <update id="updateStockAndSales">
        UPDATE teas
        SET stock = stock - #{quantity,jdbcType=INTEGER},
        sales = sales + #{quantity,jdbcType=INTEGER},
        update_time = now()
        WHERE id = #{id,jdbcType=VARCHAR} AND stock >= #{quantity,jdbcType=INTEGER}
    </update>
    
    <!-- 恢复库存和销量 -->
    <update id="restoreStockAndSales">
        UPDATE teas
        SET stock = stock + #{quantity,jdbcType=INTEGER},
        sales = CASE 
            WHEN sales >= #{quantity,jdbcType=INTEGER} THEN sales - #{quantity,jdbcType=INTEGER}
            ELSE 0
        END,
        update_time = now()
        WHERE id = #{id,jdbcType=VARCHAR}
    </update>
    
    <!-- 逻辑删除茶叶 -->
    <update id="deleteById">
        UPDATE teas
        SET is_deleted = 1,
            update_time = now()
        WHERE id = #{id,jdbcType=BIGINT}
    </update>
    
    <!-- 批量更新茶叶状态 -->
    <update id="batchUpdateStatus">
        UPDATE teas
        SET status = #{status,jdbcType=INTEGER},
        update_time = now()
        WHERE id IN
        <foreach collection="teaIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>
    
    <!-- 统计指定分类下的茶叶数量 -->
    <select id="countByCategory" resultType="java.lang.Integer" parameterType="java.lang.Integer">
        SELECT COUNT(*)
        FROM teas
        WHERE category_id = #{categoryId,jdbcType=INTEGER} AND is_deleted = 0
    </select>
</mapper>