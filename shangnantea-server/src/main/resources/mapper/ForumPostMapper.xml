<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shangnantea.mapper.ForumPostMapper">
    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.shangnantea.model.entity.forum.ForumPost">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="topic_id" property="topicId"/>
        <result column="title" property="title"/>
        <result column="content" property="content"/>
        <result column="summary" property="summary"/>
        <result column="cover_image" property="coverImage"/>
        <result column="images" property="images"/>
        <result column="view_count" property="viewCount"/>
        <result column="reply_count" property="replyCount"/>
        <result column="like_count" property="likeCount"/>
        <result column="favorite_count" property="favoriteCount"/>
        <result column="is_sticky" property="isSticky"/>
        <result column="is_essence" property="isEssence"/>
        <result column="status" property="status"/>
        <result column="last_reply_time" property="lastReplyTime"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <!-- 所有列 -->
    <sql id="Base_Column_List">
        id, user_id, topic_id, title, content, summary, cover_image, images, view_count, reply_count, 
        like_count, favorite_count, is_sticky, is_essence, status, last_reply_time, create_time, update_time
    </sql>

    <!-- 插入记录 -->
    <insert id="insert" parameterType="com.shangnantea.model.entity.forum.ForumPost">
        INSERT INTO forum_posts (
            id, user_id, topic_id, title, content, summary, cover_image, images, view_count, reply_count, 
            like_count, favorite_count, is_sticky, is_essence, status, last_reply_time, create_time, update_time
        ) VALUES (
            #{id}, #{userId}, #{topicId}, #{title}, #{content}, #{summary}, #{coverImage}, #{images}, #{viewCount}, 
            #{replyCount}, #{likeCount}, #{favoriteCount}, #{isSticky}, #{isEssence}, #{status}, 
            #{lastReplyTime}, #{createTime}, #{updateTime}
        )
    </insert>

    <!-- 根据主键删除记录 -->
    <delete id="deleteById" parameterType="java.lang.Long">
        DELETE FROM forum_posts WHERE id = #{id}
    </delete>

    <!-- 根据主键批量删除记录 -->
    <delete id="deleteByIds" parameterType="java.util.List">
        DELETE FROM forum_posts WHERE id IN
        <foreach collection="list" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- 根据主键更新记录 -->
    <update id="updateById" parameterType="com.shangnantea.model.entity.forum.ForumPost">
        UPDATE forum_posts
        <set>
            <if test="userId != null">user_id = #{userId},</if>
            <if test="topicId != null">topic_id = #{topicId},</if>
            <if test="title != null">title = #{title},</if>
            <if test="content != null">content = #{content},</if>
            <if test="summary != null">summary = #{summary},</if>
            <if test="coverImage != null">cover_image = #{coverImage},</if>
            <if test="images != null">images = #{images},</if>
            <if test="viewCount != null">view_count = #{viewCount},</if>
            <if test="replyCount != null">reply_count = #{replyCount},</if>
            <if test="likeCount != null">like_count = #{likeCount},</if>
            <if test="favoriteCount != null">favorite_count = #{favoriteCount},</if>
            <if test="isSticky != null">is_sticky = #{isSticky},</if>
            <if test="isEssence != null">is_essence = #{isEssence},</if>
            <if test="status != null">status = #{status},</if>
            <if test="lastReplyTime != null">last_reply_time = #{lastReplyTime},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </set>
        WHERE id = #{id}
    </update>

    <!-- 根据主键查询记录（排除已删除） -->
    <select id="selectById" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM forum_posts
        WHERE id = #{id} AND status != 2
    </select>
    
    <!-- 查询正常状态的帖子（支持版块和关键词过滤） -->
    <select id="selectPublishedPosts" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM forum_posts
        WHERE status = #{status}
        <if test="topicId != null">
            AND topic_id = #{topicId}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (title LIKE CONCAT('%', #{keyword}, '%') OR content LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY is_sticky DESC, create_time DESC
    </select>
    
    <!-- 根据状态查询帖子 -->
    <select id="selectByStatus" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM forum_posts
        WHERE status = #{status}
        ORDER BY create_time DESC
    </select>

    <!-- 根据主键批量查询记录 -->
    <select id="selectByIds" parameterType="java.util.List" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM forum_posts
        WHERE id IN
        <foreach collection="list" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <!-- 查询所有记录 -->
    <select id="selectAll" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM forum_posts
    </select>

    <!-- 统计记录总数 -->
    <select id="count" resultType="java.lang.Long">
        SELECT COUNT(*) FROM forum_posts
    </select>
</mapper> 