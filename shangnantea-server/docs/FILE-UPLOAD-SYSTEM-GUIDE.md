# 文件上传系统全流程指南

> **文档定位**：这是商南茶项目文件上传系统的核心指导文档，记录了完整的设计方案、实现思路和技术细节。
> 
> **使用说明**：
> - 🔴 **必须掌握** - 核心架构，必须清晰理解
> - 🟡 **需要了解** - 重要概念，了解存在即可
> - 🟢 **参考资料** - 辅助信息，需要时查阅
>
> **⚠️ 重要：文档同步维护原则**
> 
> 本文档记录了我们在图片上传功能开发中的核心决策和实现方案。它的价值在于：
> - 记录完整的技术方案，确保后续开发不偏离既定架构
> - 详细说明每个接口的职责和数据流向
> - 提供标准的实现模板，避免重复造轮子
> 
> **给 AI 的关键提示**：当你在工作中发现以下情况时，**必须主动更新本文档**：
> - ✅ 新增了图片上传接口
> - ✅ 修改了FileUploadUtils工具类的核心逻辑
> - ✅ 改变了文件存储路径规则
> - ✅ 修改了数据库存储字段
> - ✅ 发现文档内容与实际代码不符
> 
> 这样才能确保后续丢失上下文的 AI 能够获得准确的指导，直接继续开发工作。

## 目录

- [🔴 系统概览（必读）](#-系统概览必读)
- [🔴 图片上传接口统计](#-图片上传接口统计)
- [🔴 完整上传流程](#-完整上传流程)
- [🟡 工具类详解](#-工具类详解)
- [🟡 数据库存储策略](#-数据库存储策略)
- [🟢 实现模板](#-实现模板)
- [🟢 常见问题与优化](#-常见问题与优化)

---

## 🔴 系统概览（必读）

### 核心理念

**采用方案1（分离上传）：先上传图片获取URL，再提交业务数据**

我们的目标：
1. **统一处理**：所有图片上传使用统一的FileUploadUtils工具类
2. **分类存储**：根据业务类型(type)分目录存储
3. **职责分离**：前端只传文件，后端Service层硬编码type
4. **安全可控**：文件验证、路径安全、自动压缩

### 技术架构

```
前端上传文件
    ↓
Controller接收 (@RequestParam("file") MultipartFile file)
    ↓
Service层处理
    ├─ 硬编码type（如 "avatars", "posts", "messages"）
    ├─ 调用工具类：FileUploadUtils.uploadImage(file, type)
    │   └─ 工具类处理：
    │       ├─ 验证文件（类型、大小）
    │       ├─ 生成文件名（时间戳+UUID）
    │       ├─ 构建路径（files/images/{type}/{year}/{month}/{day}/{filename}）
    │       ├─ 保存文件（压缩、存储）
    │       └─ 返回相对路径
    ├─ 生成访问URL
    └─ 业务逻辑决策：
        ├─ 场景1：直接存数据库（如头像）
        ├─ 场景2：只返回URL（如帖子图片，等发帖时再存）
        └─ 场景3：上传+业务操作（如聊天图片，上传并创建消息）
    ↓
返回Result给前端
```

### 文件存储规则

**存储路径格式**：`files/images/{type}/{year}/{month}/{day}/{filename}`

**文件命名格式**：`{时间戳}_{UUID}.{扩展名}`

**示例**：`files/images/avatars/2024/01/18/20240118120530_abc123def456.jpg`

---

## 🔴 图片上传接口统计

### 接口总览

**总计：9个图片上传接口**

| 序号 | 接口名称 | 路径 | Type分类 | 数据库表 | 存储字段 | 业务场景 |
|------|----------|------|----------|----------|----------|----------|