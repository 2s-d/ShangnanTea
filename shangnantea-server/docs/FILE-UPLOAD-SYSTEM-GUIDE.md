# æ–‡ä»¶ä¸Šä¼ ç³»ç»Ÿå…¨æµç¨‹æŒ‡å—

> **æ–‡æ¡£å®šä½**ï¼šè¿™æ˜¯ä¸€ä»½å®Œæ•´çš„æ–‡ä»¶ä¸Šä¼ ç³»ç»ŸæŒ‡å¯¼æ–‡æ¡£ï¼Œè®°å½•äº†é¡¹ç›®ä¸­æ‰€æœ‰å›¾ç‰‡ä¸Šä¼ æ¥å£çš„è®¾è®¡æ€è·¯ã€å®ç°æ–¹æ¡ˆå’ŒæŠ€æœ¯ç»†èŠ‚ã€‚
> 
> **ä½¿ç”¨è¯´æ˜**ï¼š
> - ğŸ”´ **å¿…é¡»æŒæ¡** - æ ¸å¿ƒæµç¨‹ï¼Œå¿…é¡»æ¸…æ™°ç†è§£
> - ğŸŸ¡ **éœ€è¦äº†è§£** - é‡è¦æ¦‚å¿µï¼Œäº†è§£å­˜åœ¨å³å¯
> - ğŸŸ¢ **å‚è€ƒèµ„æ–™** - è¾…åŠ©ä¿¡æ¯ï¼Œéœ€è¦æ—¶æŸ¥é˜…
>
> **âš ï¸ é‡è¦ï¼šæ–‡æ¡£åŒæ­¥ç»´æŠ¤åŸåˆ™**
> 
> æœ¬æ–‡æ¡£è®°å½•äº†æˆ‘ä»¬çš„æ–‡ä»¶ä¸Šä¼ ç³»ç»Ÿçš„å®Œæ•´è®¾è®¡æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š
> - 9ä¸ªå›¾ç‰‡ä¸Šä¼ æ¥å£çš„è¯¦ç»†ä¿¡æ¯
> - ç»Ÿä¸€çš„æ–‡ä»¶å¤„ç†å·¥å…·ç±»
> - åˆ†ç±»å­˜å‚¨ç­–ç•¥
> - æ•°æ®åº“å­˜å‚¨æ–¹æ¡ˆ
> - å®Œæ•´çš„ä¸šåŠ¡æµç¨‹
> 
> **ç»™ AI çš„å…³é”®æç¤º**ï¼šå½“ä½ åœ¨å·¥ä½œä¸­å‘ç°ä»¥ä¸‹æƒ…å†µæ—¶ï¼Œ**å¿…é¡»ä¸»åŠ¨æ›´æ–°æœ¬æ–‡æ¡£**ï¼š
> - âœ… æ–°å¢äº†å›¾ç‰‡ä¸Šä¼ æ¥å£
> - âœ… ä¿®æ”¹äº†æ–‡ä»¶å­˜å‚¨è·¯å¾„è§„åˆ™
> - âœ… æ›´æ–°äº†FileUploadUtilså·¥å…·ç±»
> - âœ… æ”¹å˜äº†æ•°æ®åº“å­˜å‚¨æ–¹æ¡ˆ
> - âœ… å‘ç°æ–‡æ¡£å†…å®¹ä¸å®é™…ä»£ç ä¸ç¬¦
> 
> è¿™æ ·æ‰èƒ½ç¡®ä¿åç»­ä¸¢å¤±ä¸Šä¸‹æ–‡çš„ AI èƒ½å¤Ÿå‡†ç¡®ç†è§£æˆ‘ä»¬çš„è®¾è®¡æ€è·¯ï¼Œç›´æ¥ç»§ç»­å¼€å‘ã€‚

## ç›®å½•

- [ğŸ”´ å›¾ç‰‡ä¸Šä¼ æ¥å£ç»Ÿè®¡ï¼ˆå¿…è¯»ï¼‰](#-å›¾ç‰‡ä¸Šä¼ æ¥å£ç»Ÿè®¡å¿…è¯»)
- [ğŸ”´ æ–‡ä»¶ä¸Šä¼ å…¨æµç¨‹](#-æ–‡ä»¶ä¸Šä¼ å…¨æµç¨‹)
- [ğŸ”´ å·¥å…·ç±»ä½¿ç”¨æŒ‡å—](#-å·¥å…·ç±»ä½¿ç”¨æŒ‡å—)
- [ğŸŸ¡ æ•°æ®åº“å­˜å‚¨æ–¹æ¡ˆ](#-æ•°æ®åº“å­˜å‚¨æ–¹æ¡ˆ)
- [ğŸŸ¡ æ–‡ä»¶å­˜å‚¨ç­–ç•¥](#-æ–‡ä»¶å­˜å‚¨ç­–ç•¥)
- [ğŸŸ¢ æ¥å£å®ç°æ¨¡æ¿](#-æ¥å£å®ç°æ¨¡æ¿)
- [ğŸŸ¢ å¸¸è§é—®é¢˜ä¸ä¼˜åŒ–](#-å¸¸è§é—®é¢˜ä¸ä¼˜åŒ–)

---

## ğŸ”´ å›¾ç‰‡ä¸Šä¼ æ¥å£ç»Ÿè®¡ï¼ˆå¿…è¯»ï¼‰

### æ¥å£æ€»è§ˆ

**é¡¹ç›®å…±æœ‰ 9 ä¸ªå›¾ç‰‡ä¸Šä¼ æ¥å£**ï¼Œé‡‡ç”¨ç»Ÿä¸€çš„æŠ€æœ¯æ–¹æ¡ˆï¼š

| åºå· | æ¥å£åç§° | Typeåˆ†ç±» | æ•°æ®åº“è¡¨ | å­˜å‚¨å­—æ®µ | ä¸šåŠ¡åœºæ™¯ |
|------|----------|----------|----------|----------|----------|
| 1 | uploadAvatar | avatars | users | avatar | ç”¨æˆ·å¤´åƒä¸Šä¼  |
| 2 | uploadCertificationImage | certifications | shop_certifications | id_card_front, id_card_back, business_license | å•†å®¶è®¤è¯å›¾ç‰‡ |
| 3 | uploadTeaImages | teas | tea_images | url | èŒ¶å¶å›¾ç‰‡ä¸Šä¼  |
| 4 | uploadShopLogo | logos | shops | logo | åº—é“ºLogoä¸Šä¼  |
| 5 | uploadShopBanner | shop-banners | shop_banners | image_url | åº—é“ºè½®æ’­å›¾ |
| 6 | uploadReviewImage | reviews | tea_reviews | images | è®¢å•è¯„ä»·å›¾ç‰‡ |
| 7 | uploadBanner | forum-banners | home_contents | content | è®ºå›é¦–é¡µè½®æ’­å›¾ |
| 8 | sendImageMessage | messages | chat_messages | content | èŠå¤©å›¾ç‰‡æ¶ˆæ¯ |
| 9 | uploadPostImage | posts | forum_posts | images | è®ºå›å¸–å­å›¾ç‰‡ |

### çŠ¶æ€ç ç»Ÿè®¡

æ¯ä¸ªæ¥å£éƒ½æœ‰å¯¹åº”çš„æˆåŠŸå’Œå¤±è´¥çŠ¶æ€ç ï¼š

| æ¥å£ | æˆåŠŸç  | å¤±è´¥ç  | è¯´æ˜ |
|------|--------|--------|------|
| uploadAvatar | 2004 | 2109, 2110, 2111 | å¤´åƒæ›´æ–°æˆåŠŸ/å¤±è´¥ |
| uploadCertificationImage | 2024 | 2146, 2147, 2148 | è®¤è¯å›¾ç‰‡ä¸Šä¼ æˆåŠŸ/å¤±è´¥ |
| uploadTeaImages | 3014 | 3120, 3121, 3122 | èŒ¶å¶å›¾ç‰‡ä¸Šä¼ æˆåŠŸ/å¤±è´¥ |
| uploadShopLogo | 4007 | 4113, 4114, 4115 | Logoä¸Šä¼ æˆåŠŸ/å¤±è´¥ |
| uploadShopBanner | 4008 | 4117, 4118, 4119 | Bannerä¸Šä¼ æˆåŠŸ/å¤±è´¥ |
| uploadReviewImage | 5016 | 5144, 5145, 5146 | è¯„ä»·å›¾ç‰‡ä¸Šä¼ æˆåŠŸ/å¤±è´¥ |
| uploadBanner | 6001 | 6103, 6104, 6105 | è®ºå›Bannerä¸Šä¼ æˆåŠŸ/å¤±è´¥ |
| sendImageMessage | 7009 | 7116, 7117, 7118 | å›¾ç‰‡æ¶ˆæ¯å‘é€æˆåŠŸ/å¤±è´¥ |
| uploadPostImage | 6028 | 6140, 6141, 6142 | å¸–å­å›¾ç‰‡ä¸Šä¼ æˆåŠŸ/å¤±è´¥ |

### æŠ€æœ¯æ–¹æ¡ˆç»Ÿä¸€æ€§

**æ‰€æœ‰æ¥å£é‡‡ç”¨ç›¸åŒçš„æŠ€æœ¯æ–¹æ¡ˆ**ï¼š
- **å‰ç«¯**ï¼šä½¿ç”¨FormData + multipart/form-dataä¸Šä¼ 
- **åç«¯**ï¼šControlleræ¥æ”¶ â†’ Serviceå¤„ç† â†’ è°ƒç”¨FileUploadUtilså·¥å…·ç±»
- **å­˜å‚¨**ï¼šç»Ÿä¸€çš„æ–‡ä»¶å‘½åå’Œç›®å½•ç»“æ„
- **è¿”å›**ï¼šç»Ÿä¸€çš„å“åº”æ ¼å¼ {url, path}

---

## ğŸ”´ æ–‡ä»¶ä¸Šä¼ å…¨æµç¨‹

### æµç¨‹æ¦‚è§ˆ

```
å‰ç«¯ä¸Šä¼ æ–‡ä»¶
    â†“
Controlleræ¥æ”¶ (@RequestParam("file") MultipartFile file)
    â”œâ”€ @RequiresLogin æƒé™éªŒè¯
    â”œâ”€ æ—¥å¿—è®°å½•ï¼šlogger.info("ä¸Šä¼ [ä¸šåŠ¡]å›¾ç‰‡è¯·æ±‚, æ–‡ä»¶å: {}", file.getOriginalFilename())
    â””â”€ è°ƒç”¨Serviceå±‚æ–¹æ³•
    â†“
Serviceå±‚å¤„ç†
    â”œâ”€ è·å–å½“å‰ç”¨æˆ·IDï¼šUserContext.getCurrentUserId()
    â”œâ”€ ç”¨æˆ·èº«ä»½éªŒè¯ï¼šgetUserEntityById(userId)
    â”œâ”€ ç¡¬ç¼–ç typeï¼ˆå¦‚ "avatars", "posts", "messages"ï¼‰
    â”œâ”€ è°ƒç”¨å·¥å…·ç±»ï¼šFileUploadUtils.uploadImage(file, type)
    â”‚   â””â”€ å·¥å…·ç±»å¤„ç†ï¼š
    â”‚       â”œâ”€ éªŒè¯æ–‡ä»¶ï¼ˆç±»å‹ã€å¤§å°ã€æ‰©å±•åï¼‰
    â”‚       â”œâ”€ ç”Ÿæˆæ–‡ä»¶åï¼ˆæ—¶é—´æˆ³_UUID.æ‰©å±•åï¼‰
    â”‚       â”œâ”€ æ„å»ºè·¯å¾„ï¼ˆfiles/images/{type}/{year}/{month}/{day}/{filename}ï¼‰
    â”‚       â”œâ”€ ç¡®ä¿ç›®å½•å­˜åœ¨
    â”‚       â”œâ”€ ä¿å­˜æ–‡ä»¶ï¼ˆ>1MBè‡ªåŠ¨å‹ç¼©åˆ°1200pxå®½åº¦ï¼‰
    â”‚       â””â”€ è¿”å›ç›¸å¯¹è·¯å¾„
    â”œâ”€ ç”Ÿæˆè®¿é—®URLï¼šFileUploadUtils.generateAccessUrl(relativePath, baseUrl)
    â””â”€ ä¸šåŠ¡é€»è¾‘å†³ç­–ï¼š
        â”œâ”€ åœºæ™¯1ï¼šç›´æ¥å­˜æ•°æ®åº“ï¼ˆå¦‚å¤´åƒï¼‰
        â”‚   â”œâ”€ æ›´æ–°æ•°æ®åº“ï¼šmapper.updateAvatar(userId, relativePath)
        â”‚   â””â”€ è¿”å› {url, path}
        â”œâ”€ åœºæ™¯2ï¼šåªè¿”å›URLï¼ˆå¦‚å¸–å­å›¾ç‰‡ï¼Œç­‰å‘å¸–æ—¶å†å­˜ï¼‰
        â”‚   â””â”€ ç›´æ¥è¿”å› {url, path}
        â””â”€ åœºæ™¯3ï¼šä¸Šä¼ +ä¸šåŠ¡æ“ä½œï¼ˆå¦‚èŠå¤©å›¾ç‰‡ï¼Œä¸Šä¼ å¹¶åˆ›å»ºæ¶ˆæ¯ï¼‰
            â”œâ”€ åˆ›å»ºä¸šåŠ¡è®°å½•
            â””â”€ è¿”å›ä¸šåŠ¡ç»“æœ
    â†“
è¿”å›Resultç»™å‰ç«¯ï¼ˆç»Ÿä¸€æ ¼å¼ï¼šResult.success(çŠ¶æ€ç , {url, path})ï¼‰
```

### ä¸‰ç§ä¸šåŠ¡åœºæ™¯

**åœºæ™¯1ï¼šç›´æ¥å­˜æ•°æ®åº“ï¼ˆå¦‚å¤´åƒä¸Šä¼ ï¼‰**
- ä¸Šä¼ æ–‡ä»¶ â†’ è°ƒç”¨å·¥å…·ç±» â†’ æ›´æ–°æ•°æ®åº“ â†’ è¿”å›ç»“æœ
- é€‚ç”¨æ¥å£ï¼šuploadAvatar, uploadShopLogo
- **å®é™…å®ç°è¦ç‚¹**ï¼š
  - éœ€è¦åœ¨Mapperä¸­å®šä¹‰ä¸“é—¨çš„æ›´æ–°æ–¹æ³•ï¼ˆå¦‚updateAvatarï¼‰
  - éœ€è¦åœ¨XMLä¸­ç¼–å†™å¯¹åº”çš„SQLè¯­å¥
  - æ•°æ®åº“å­˜å‚¨ç›¸å¯¹è·¯å¾„ï¼Œå‰ç«¯ä½¿ç”¨å®Œæ•´URL
  - æˆåŠŸåéœ€è¦è¿”å› {url, path} æ ¼å¼çš„æ•°æ®

**åœºæ™¯2ï¼šå…ˆè¿”å›URLï¼Œç¨åå­˜å‚¨ï¼ˆå¦‚å¸–å­å›¾ç‰‡ï¼‰**
- ä¸Šä¼ æ–‡ä»¶ â†’ è°ƒç”¨å·¥å…·ç±» â†’ è¿”å›URL â†’ ç”¨æˆ·å‘å¸–æ—¶å†å­˜æ•°æ®åº“
- é€‚ç”¨æ¥å£ï¼šuploadPostImage, uploadReviewImage
- **å®é™…å®ç°è¦ç‚¹**ï¼š
  - ä¸éœ€è¦ç«‹å³æ“ä½œæ•°æ®åº“
  - ç›´æ¥è¿”å›æ–‡ä»¶URLä¾›å‰ç«¯é¢„è§ˆ
  - åœ¨åç»­ä¸šåŠ¡æ“ä½œä¸­å°†è·¯å¾„å­˜å…¥ç›¸å…³è¡¨
  - **å®ç”¨ç»éªŒ**ï¼šServiceå±‚å®ç°æœ€ç®€å•ï¼Œæ— éœ€ç”¨æˆ·èº«ä»½éªŒè¯å’Œæ•°æ®åº“æ“ä½œï¼Œåªéœ€è°ƒç”¨å·¥å…·ç±»å’Œè¿”å›ç»“æœ

**åœºæ™¯3ï¼šä¸Šä¼ +ä¸šåŠ¡æ“ä½œï¼ˆå¦‚èŠå¤©å›¾ç‰‡ï¼‰**
- ä¸Šä¼ æ–‡ä»¶ â†’ è°ƒç”¨å·¥å…·ç±» â†’ åˆ›å»ºæ¶ˆæ¯è®°å½• â†’ è¿”å›ç»“æœ
- é€‚ç”¨æ¥å£ï¼šsendImageMessage
- **å®é™…å®ç°è¦ç‚¹**ï¼š
  - éœ€è¦åŒæ—¶å¤„ç†æ–‡ä»¶ä¸Šä¼ å’Œä¸šåŠ¡é€»è¾‘
  - é€šå¸¸éœ€è¦äº‹åŠ¡æ§åˆ¶ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
  - è¿”å›çš„æ˜¯ä¸šåŠ¡æ“ä½œç»“æœï¼Œä¸ä»…ä»…æ˜¯æ–‡ä»¶ä¿¡æ¯
  - **é‡è¦ç»éªŒ**ï¼šæ•°æ®ç±»å‹åŒ¹é…é—®é¢˜ - ç¡®ä¿å®ä½“ç±»IDç±»å‹ä¸Mapperæ¥å£æ³›å‹ä¸€è‡´ï¼ˆå¦‚ChatSessionä½¿ç”¨String IDï¼ŒMapperåº”ä¸ºBaseMapper<ChatSession, String>ï¼‰

---

## ğŸ”´ å·¥å…·ç±»ä½¿ç”¨æŒ‡å—

### FileUploadUtilsæ ¸å¿ƒæ–¹æ³•

**ä¸»è¦ä¸Šä¼ æ–¹æ³•**ï¼š
```java
// åŸºç¡€ä¸Šä¼ ï¼ˆé»˜è®¤5MBé™åˆ¶ï¼‰
String relativePath = FileUploadUtils.uploadImage(file, "avatars");

// æŒ‡å®šå¤§å°é™åˆ¶
String relativePath = FileUploadUtils.uploadImage(file, "posts", 10 * 1024 * 1024);
```

**è¾…åŠ©æ–¹æ³•**ï¼š
```java
// ç”Ÿæˆè®¿é—®URLï¼ˆå¿…é¡»é…ç½®baseUrlï¼‰
String accessUrl = FileUploadUtils.generateAccessUrl(relativePath, baseUrl);

// åˆ é™¤æ–‡ä»¶
boolean success = FileUploadUtils.deleteFile(relativePath);
```

### é‡è¦é…ç½®è¦æ±‚

**application.ymlé…ç½®**ï¼š
```yaml
# åº”ç”¨é…ç½®
app:
  base-url: http://localhost:8080  # å¿…é¡»é…ç½®ï¼Œç”¨äºç”Ÿæˆè®¿é—®URL
```

**WebMvcConfigé™æ€èµ„æºæ˜ å°„**ï¼š
```java
@Override
public void addResourceHandlers(ResourceHandlerRegistry registry) {
    // é…ç½®é™æ€èµ„æºæ˜ å°„ï¼Œç”¨äºè®¿é—®ä¸Šä¼ çš„æ–‡ä»¶
    registry.addResourceHandler("/files/**")
            .addResourceLocations("file:" + System.getProperty("user.dir") + "/files/");
}

@Override
public void addInterceptors(InterceptorRegistry registry) {
    registry.addInterceptor(jwtInterceptor)
            .excludePathPatterns("/files/**");  // æ’é™¤æ–‡ä»¶è®¿é—®è·¯å¾„
}
```

### æ–‡ä»¶å‘½åè§„åˆ™

**æ ¼å¼**ï¼š`æ—¶é—´æˆ³_UUID.æ‰©å±•å`
**ç¤ºä¾‹**ï¼š`20240118120530_abc123def456.jpg`

**ä¼˜ç‚¹**ï¼š
- é¿å…æ–‡ä»¶åå†²çª
- åŒ…å«æ—¶é—´ä¿¡æ¯ï¼Œä¾¿äºç®¡ç†
- ä¸ä¾èµ–åŸæ–‡ä»¶åï¼Œå®‰å…¨æ€§é«˜

### ç›®å½•ç»“æ„è§„åˆ™

**è·¯å¾„æ ¼å¼**ï¼š`files/images/{type}/{year}/{month}/{day}/{filename}`

**ç¤ºä¾‹**ï¼š
```
files/
  images/
    avatars/2024/01/18/20240118120530_abc123.jpg
    posts/2024/01/18/20240118120530_def456.jpg
    messages/2024/01/18/20240118120530_ghi789.jpg
```

**ä¼˜ç‚¹**ï¼š
- æŒ‰ä¸šåŠ¡ç±»å‹åˆ†ç±»å­˜å‚¨
- æŒ‰æ—¥æœŸåˆ†å±‚ï¼Œä¾¿äºç®¡ç†å’Œæ¸…ç†
- æ”¯æŒå¤§é‡æ–‡ä»¶å­˜å‚¨

### æ–‡ä»¶éªŒè¯è§„åˆ™

**æ”¯æŒçš„å›¾ç‰‡ç±»å‹**ï¼š
- MIMEç±»å‹ï¼šimage/jpeg, image/jpg, image/png, image/gif, image/webp
- æ‰©å±•åï¼š.jpg, .jpeg, .png, .gif, .webp

**æ–‡ä»¶å¤§å°é™åˆ¶**ï¼š
- é»˜è®¤ï¼š5MB
- å¯è‡ªå®šä¹‰ï¼šé€šè¿‡å‚æ•°æŒ‡å®š

**å›¾ç‰‡å‹ç¼©**ï¼š
- è§¦å‘æ¡ä»¶ï¼šæ–‡ä»¶å¤§å° > 1MB
- å‹ç¼©è§„åˆ™ï¼šå®½åº¦å‹ç¼©åˆ°1200pxï¼Œä¿æŒæ¯”ä¾‹
- å‹ç¼©è´¨é‡ï¼š85%
- **æ³¨æ„**ï¼šå‹ç¼©åªé’ˆå¯¹è¿‡å¤§å›¾ç‰‡ï¼Œå°å›¾ç‰‡ç›´æ¥ä¿å­˜

**å®‰å…¨éªŒè¯**ï¼š
- æ–‡ä»¶ç±»å‹åŒé‡éªŒè¯ï¼ˆMIMEç±»å‹ + æ‰©å±•åï¼‰
- è·¯å¾„éå†æ”»å‡»é˜²æŠ¤ï¼ˆä¸å…è®¸åŒ…å«..å’Œ\ï¼‰
- æ–‡ä»¶åå®‰å…¨åŒ–ï¼ˆä½¿ç”¨UUIDé¿å…å†²çªï¼‰

---

## ğŸŸ¡ æ•°æ®åº“å­˜å‚¨æ–¹æ¡ˆ

### å­˜å‚¨å­—æ®µç±»å‹

**å•ä¸ªå›¾ç‰‡å­—æ®µ**ï¼š
```sql
-- ç”¨æˆ·å¤´åƒ
users.avatar VARCHAR(255) -- å­˜å‚¨ç›¸å¯¹è·¯å¾„

-- åº—é“ºLogo
shops.logo VARCHAR(255) -- å­˜å‚¨ç›¸å¯¹è·¯å¾„

-- èŒ¶å¶ä¸»å›¾
teas.main_image VARCHAR(255) -- å­˜å‚¨ç›¸å¯¹è·¯å¾„
```

**å¤šå›¾ç‰‡JSONå­—æ®µ**ï¼š
```sql
-- è®ºå›å¸–å­å›¾ç‰‡
forum_posts.images TEXT -- JSONæ•°ç»„æ ¼å¼

-- èŒ¶å¶è¯„ä»·å›¾ç‰‡  
tea_reviews.images TEXT -- JSONæ•°ç»„æ ¼å¼

-- èŒ¶æ–‡åŒ–æ–‡ç« å›¾ç‰‡
tea_articles.images TEXT -- JSONæ•°ç»„æ ¼å¼
```

**ä¸“ç”¨å›¾ç‰‡è¡¨**ï¼š
```sql
-- èŒ¶å¶å›¾ç‰‡è¡¨
tea_images.image_url VARCHAR(255) -- å­˜å‚¨ç›¸å¯¹è·¯å¾„

-- åº—é“ºBannerè¡¨
shop_banners.image_url VARCHAR(255) -- å­˜å‚¨ç›¸å¯¹è·¯å¾„
```

**ç‰¹æ®Šå­˜å‚¨æ–¹å¼**ï¼š
```sql
-- èŠå¤©æ¶ˆæ¯ï¼ˆå›¾ç‰‡URLå­˜åœ¨contentå­—æ®µï¼‰
chat_messages.content TEXT -- å­˜å‚¨å®Œæ•´è®¿é—®URL
chat_messages.content_type VARCHAR(20) -- 'image'æ ‡è¯†

-- é¦–é¡µå†…å®¹ï¼ˆè½®æ’­å›¾ç­‰ï¼‰
home_contents.content TEXT -- å­˜å‚¨å›¾ç‰‡ç›¸å…³æ•°æ®
```

### å­˜å‚¨è·¯å¾„è§„åˆ™

**æ•°æ®åº“å­˜å‚¨**ï¼šç›¸å¯¹è·¯å¾„ï¼ˆå¦‚ï¼š`files/images/avatars/2024/01/18/xxx.jpg`ï¼‰
**å‰ç«¯è®¿é—®**ï¼šå®Œæ•´URLï¼ˆå¦‚ï¼š`http://localhost:8080/files/images/avatars/2024/01/18/xxx.jpg`ï¼‰

**ä¼˜ç‚¹**ï¼š
- æ•°æ®åº“å­˜å‚¨ç©ºé—´å°
- åŸŸåå˜æ›´æ—¶æ— éœ€ä¿®æ”¹æ•°æ®åº“
- ä¾¿äºæ–‡ä»¶è¿ç§»

---

## ğŸŸ¡ æ–‡ä»¶å­˜å‚¨ç­–ç•¥

### å­˜å‚¨ä½ç½®

**å¼€å‘ç¯å¢ƒ**ï¼šé¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ `files/` æ–‡ä»¶å¤¹
**ç”Ÿäº§ç¯å¢ƒ**ï¼šå¯é…ç½®åˆ°ç‹¬ç«‹çš„æ–‡ä»¶æœåŠ¡å™¨æˆ–CDN

### æ¸…ç†ç­–ç•¥

**å®šæ—¶æ¸…ç†ä»»åŠ¡**ï¼ˆFileCleanupTaskï¼‰ï¼š
- **æ‰§è¡Œæ—¶é—´**ï¼šæ¯å¤©å‡Œæ™¨3ç‚¹
- **æ¸…ç†è§„åˆ™**ï¼šåˆ é™¤7å¤©å‰çš„å­¤å„¿æ–‡ä»¶
- **å®‰å…¨æ¨¡å¼**ï¼šå½“å‰åªè®°å½•æ—¥å¿—ï¼Œä¸è‡ªåŠ¨åˆ é™¤

**æ‰‹åŠ¨åˆ é™¤**ï¼š
- ä¸šåŠ¡åˆ é™¤æ—¶è°ƒç”¨ `FileUploadUtils.deleteFile()`
- ç«‹å³åˆ é™¤å¯¹åº”çš„ç‰©ç†æ–‡ä»¶

### è®¿é—®é…ç½®

**é™æ€èµ„æºæ˜ å°„**ï¼ˆWebMvcConfigï¼‰ï¼š
```java
@Override
public void addResourceHandlers(ResourceHandlerRegistry registry) {
    registry.addResourceHandler("/files/**")
            .addResourceLocations("file:" + System.getProperty("user.dir") + "/files/");
}
```

**è®¿é—®URLæ ¼å¼**ï¼š`http://åŸŸå/files/images/{type}/{year}/{month}/{day}/{filename}`

---

## ğŸŸ¢ æ¥å£å®ç°æ¨¡æ¿

### Controllerå±‚æ¨¡æ¿

```java
/**
 * ä¸Šä¼ [ä¸šåŠ¡]å›¾ç‰‡
 * è·¯å¾„: POST /[æ¨¡å—]/[åŠŸèƒ½]/image
 * æˆåŠŸç : [xxxx], å¤±è´¥ç : [xxxx, xxxx, xxxx]
 */
@PostMapping("/[åŠŸèƒ½]/image")
@RequiresLogin
public Result<Map<String, Object>> upload[ä¸šåŠ¡]Image(@RequestParam("file") MultipartFile file) {
    logger.info("ä¸Šä¼ [ä¸šåŠ¡]å›¾ç‰‡è¯·æ±‚, æ–‡ä»¶å: {}", file.getOriginalFilename());
    return [æ¨¡å—]Service.upload[ä¸šåŠ¡]Image(file);
}
```

### Serviceå±‚æ¨¡æ¿

**åœºæ™¯1ï¼šç›´æ¥å­˜æ•°æ®åº“ï¼ˆå¦‚å¤´åƒä¸Šä¼ ï¼‰**
```java
@Override
@Transactional(rollbackFor = Exception.class)  // é‡è¦ï¼šæ·»åŠ äº‹åŠ¡æ³¨è§£
public Result<Map<String, Object>> upload[ä¸šåŠ¡]Image(MultipartFile file) {
    try {
        // 1. è·å–å½“å‰ç”¨æˆ·ID
        String userId = UserContext.getCurrentUserId();
        if (userId == null) {
            logger.warn("[ä¸šåŠ¡]å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ç”¨æˆ·æœªç™»å½•");
            return Result.failure([å¤±è´¥ç 1]); // ç”¨æˆ·æœªç™»å½•
        }
        
        // 2. éªŒè¯ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼ˆæ ¹æ®ä¸šåŠ¡éœ€è¦ï¼‰
        User user = getUserEntityById(userId);
        if (user == null) {
            logger.warn("[ä¸šåŠ¡]å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ç”¨æˆ·ä¸å­˜åœ¨, userId: {}", userId);
            return Result.failure([å¤±è´¥ç 1]); // ç”¨æˆ·ä¸å­˜åœ¨
        }
        
        // 3. è°ƒç”¨å·¥å…·ç±»ä¸Šä¼ ï¼ˆç¡¬ç¼–ç typeï¼‰
        String relativePath = FileUploadUtils.uploadImage(file, "[type]");
        
        // 4. ç”Ÿæˆè®¿é—®URL
        String accessUrl = FileUploadUtils.generateAccessUrl(relativePath, baseUrl);
        
        // 5. æ›´æ–°æ•°æ®åº“
        int result = [mapper].update[å­—æ®µ](userId, relativePath);
        if (result <= 0) {
            logger.error("[ä¸šåŠ¡]å›¾ç‰‡ä¸Šä¼ å¤±è´¥: æ•°æ®åº“æ›´æ–°å¤±è´¥, userId: {}", userId);
            return Result.failure([å¤±è´¥ç 2]); // æ•°æ®åº“æ›´æ–°å¤±è´¥
        }
        
        // 6. è¿”å›ç»“æœ
        Map<String, Object> responseData = new HashMap<>();
        responseData.put("url", accessUrl);
        responseData.put("path", relativePath);
        
        logger.info("[ä¸šåŠ¡]å›¾ç‰‡ä¸Šä¼ æˆåŠŸ: userId: {}, path: {}", userId, relativePath);
        return Result.success([æˆåŠŸç ], responseData);
        
    } catch (BusinessException e) {
        logger.error("[ä¸šåŠ¡]å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ä¸šåŠ¡å¼‚å¸¸", e);
        return Result.failure([å¤±è´¥ç 3]); // ä¸šåŠ¡å¼‚å¸¸
    } catch (Exception e) {
        logger.error("[ä¸šåŠ¡]å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ç³»ç»Ÿå¼‚å¸¸", e);
        return Result.failure([å¤±è´¥ç 3]); // ç³»ç»Ÿå¼‚å¸¸
    }
}
```

**åœºæ™¯2ï¼šåªè¿”å›URL**
```java
@Override
public Result<Map<String, Object>> upload[ä¸šåŠ¡]Image(MultipartFile file) {
    try {
        // 1. è°ƒç”¨å·¥å…·ç±»ä¸Šä¼ 
        String relativePath = FileUploadUtils.uploadImage(file, "[type]");
        
        // 2. ç”Ÿæˆè®¿é—®URL
        String accessUrl = FileUploadUtils.generateAccessUrl(relativePath, baseUrl);
        
        // 3. ç›´æ¥è¿”å›ï¼Œä¸å­˜æ•°æ®åº“
        Map<String, Object> responseData = new HashMap<>();
        responseData.put("url", accessUrl);
        responseData.put("path", relativePath);
        
        logger.info("[ä¸šåŠ¡]å›¾ç‰‡ä¸Šä¼ æˆåŠŸ: path: {}", relativePath);
        return Result.success([æˆåŠŸç ], responseData);
        
    } catch (BusinessException e) {
        logger.error("[ä¸šåŠ¡]å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ä¸šåŠ¡å¼‚å¸¸", e);
        return Result.failure([å¤±è´¥ç ]);
    } catch (Exception e) {
        logger.error("[ä¸šåŠ¡]å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ç³»ç»Ÿå¼‚å¸¸", e);
        return Result.failure([å¤±è´¥ç ]);
    }
}
```

**åœºæ™¯3ï¼šä¸Šä¼ +ä¸šåŠ¡æ“ä½œ**
```java
@Override
@Transactional(rollbackFor = Exception.class)  // é‡è¦ï¼šäº‹åŠ¡æ§åˆ¶
public Result<Object> send[ä¸šåŠ¡]Message(String sessionId, String receiverId, MultipartFile file) {
    try {
        // 1. è·å–å½“å‰ç”¨æˆ·ID
        String senderId = UserContext.getCurrentUserId();
        if (senderId == null) {
            logger.warn("[ä¸šåŠ¡]æ¶ˆæ¯å‘é€å¤±è´¥: ç”¨æˆ·æœªç™»å½•");
            return Result.failure([å¤±è´¥ç 1]);
        }
        
        // 2. éªŒè¯ä¸šåŠ¡å¯¹è±¡æ˜¯å¦å­˜åœ¨ï¼ˆå¦‚ä¼šè¯ï¼‰
        [ä¸šåŠ¡å¯¹è±¡] object = [mapper].selectById(sessionId);
        if (object == null) {
            logger.warn("[ä¸šåŠ¡]æ¶ˆæ¯å‘é€å¤±è´¥: å¯¹è±¡ä¸å­˜åœ¨, id: {}", sessionId);
            return Result.failure([å¤±è´¥ç 2]);
        }
        
        // 3. è°ƒç”¨å·¥å…·ç±»ä¸Šä¼ ï¼ˆç¡¬ç¼–ç typeï¼‰
        String relativePath = FileUploadUtils.uploadImage(file, "[type]");
        
        // 4. ç”Ÿæˆè®¿é—®URL
        String accessUrl = FileUploadUtils.generateAccessUrl(relativePath, baseUrl);
        
        // 5. åˆ›å»ºä¸šåŠ¡è®°å½•
        [ä¸šåŠ¡è®°å½•] record = new [ä¸šåŠ¡è®°å½•]();
        record.setContent(accessUrl); // å­˜å‚¨å®Œæ•´URL
        record.setContentType("image"); // æ ‡è¯†ç±»å‹
        record.setSenderId(senderId);
        record.setReceiverId(receiverId);
        record.setCreateTime(new Date());
        
        // 6. ä¿å­˜åˆ°æ•°æ®åº“
        int result = [mapper].insert(record);
        if (result <= 0) {
            logger.error("[ä¸šåŠ¡]æ¶ˆæ¯å‘é€å¤±è´¥: æ•°æ®åº“æ’å…¥å¤±è´¥");
            return Result.failure([å¤±è´¥ç 3]);
        }
        
        // 7. æ›´æ–°ç›¸å…³ä¸šåŠ¡å¯¹è±¡ï¼ˆå¦‚ä¼šè¯æœ€åæ¶ˆæ¯ï¼‰
        object.setLastMessage("[å›¾ç‰‡]");
        object.setLastMessageTime(new Date());
        [mapper].updateById(object);
        
        // 8. æ„é€ ä¸šåŠ¡è¿”å›æ•°æ®
        Map<String, Object> responseData = new HashMap<>();
        responseData.put("messageId", record.getId());
        responseData.put("content", accessUrl);
        responseData.put("contentType", "image");
        responseData.put("createTime", record.getCreateTime());
        
        logger.info("[ä¸šåŠ¡]æ¶ˆæ¯å‘é€æˆåŠŸ: id: {}, path: {}", record.getId(), relativePath);
        return Result.success([æˆåŠŸç ], responseData);
        
    } catch (Exception e) {
        logger.error("[ä¸šåŠ¡]æ¶ˆæ¯å‘é€å¤±è´¥: ç³»ç»Ÿå¼‚å¸¸", e);
        return Result.failure([å¤±è´¥ç 3]);
    }
}
```

### Mapperå±‚æ¨¡æ¿

**æ¥å£å®šä¹‰**ï¼š
```java
/**
 * æ›´æ–°[ä¸šåŠ¡]å›¾ç‰‡
 *
 * @param id     è®°å½•ID
 * @param [å­—æ®µ] å›¾ç‰‡è·¯å¾„
 * @return å½±å“è¡Œæ•°
 */
int update[å­—æ®µ](@Param("id") String id, @Param("[å­—æ®µ]") String [å­—æ®µ]);
```

**XMLå®ç°**ï¼š
```xml
<!-- æ›´æ–°[ä¸šåŠ¡]å›¾ç‰‡ -->
<update id="update[å­—æ®µ]">
    UPDATE [è¡¨å]
    SET [å­—æ®µ] = #{[å­—æ®µ],jdbcType=VARCHAR},
    update_time = now()
    WHERE id = #{id,jdbcType=VARCHAR}
</update>
```

### å‰ç«¯è°ƒç”¨æ¨¡æ¿

**APIå±‚**ï¼š
```javascript
export function upload[ä¸šåŠ¡]Image(file) {
  const formData = new FormData()
  formData.append('file', file)
  
  return request({
    url: API.[æ¨¡å—].[æ¥å£å¸¸é‡],
    method: 'post',
    data: formData,
    headers: {
      'Content-Type': 'multipart/form-data'
    }
  })
}
```

**Storeå±‚**ï¼š
```javascript
async upload[ä¸šåŠ¡]Image({ commit }, file) {
  try {
    const res = await upload[ä¸šåŠ¡]Image(file)
    
    // æ ¹æ®ä¸šåŠ¡åœºæ™¯å¤„ç†è¿”å›ç»“æœ
    if (res.code === [æˆåŠŸç ]) {
      // åœºæ™¯1ï¼šæ›´æ–°æœ¬åœ°çŠ¶æ€ï¼ˆå¦‚å¤´åƒï¼‰
      if (res.data && res.data.url) {
        const updatedInfo = {
          ...state.userInfo,
          [å­—æ®µ]: res.data.url
        }
        commit('SET_USER_INFO', updatedInfo)
      }
    }
    
    return res // è¿”å› {code, data: {url, path}}
  } catch (error) {
    commit('SET_ERROR', error.message || 'ä¸Šä¼ å›¾ç‰‡å¤±è´¥')
    throw error
  }
}
```

**ç»„ä»¶å±‚**ï¼š
```javascript
// ä¸Šä¼ å‰éªŒè¯
const beforeUpload = (file) => {
  const isImage = file.type.startsWith('image/')
  const isLt2M = file.size / 1024 / 1024 < 2
  
  if (!isImage) {
    // ä½¿ç”¨ç»Ÿä¸€çš„çŠ¶æ€ç æ¶ˆæ¯ç³»ç»Ÿ
    showByCode([å¤±è´¥ç 1]) // æ–‡ä»¶ç±»å‹é”™è¯¯
    return false
  }
  if (!isLt2M) {
    showByCode([å¤±è´¥ç 2]) // æ–‡ä»¶å¤§å°è¶…é™
    return false
  }
  return true
}

// ä¸Šä¼ å¤„ç†
const handleUpload = async (options) => {
  const file = options.file
  if (!file) return
  
  try {
    loading.value = true
    
    const res = await store.dispatch('[æ¨¡å—]/upload[ä¸šåŠ¡]Image', file)
    
    // ä½¿ç”¨ç»Ÿä¸€çš„çŠ¶æ€ç æ¶ˆæ¯ç³»ç»Ÿ
    showByCode(res.code)
    
    if (isSuccess(res.code)) {
      // ä¸Šä¼ æˆåŠŸï¼Œä½¿ç”¨ res.data.url æ˜¾ç¤ºå›¾ç‰‡
      imageUrl.value = res.data.url
      
      // æ ¹æ®ä¸šåŠ¡éœ€è¦åˆ·æ–°ç›¸å…³æ•°æ®
      await store.dispatch('[æ¨¡å—]/getUserInfo')
    }
  } catch (error) {
    console.error('ä¸Šä¼ å¤±è´¥:', error)
  } finally {
    loading.value = false
  }
}
```

---

## ğŸŸ¢ å¸¸è§é—®é¢˜ä¸ä¼˜åŒ–

### å¸¸è§é—®é¢˜

**Q1ï¼šæ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œæç¤º"ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹"**
- æ£€æŸ¥æ–‡ä»¶MIMEç±»å‹æ˜¯å¦åœ¨å…è®¸åˆ—è¡¨ä¸­
- æ£€æŸ¥æ–‡ä»¶æ‰©å±•åæ˜¯å¦æ­£ç¡®
- ç¡®è®¤FileUploadUtilsä¸­çš„ç±»å‹éªŒè¯é€»è¾‘

**Q2ï¼šæ–‡ä»¶è¿‡å¤§æ— æ³•ä¸Šä¼ **
- é»˜è®¤é™åˆ¶5MBï¼Œå¯é€šè¿‡å‚æ•°è°ƒæ•´
- æ£€æŸ¥æœåŠ¡å™¨ä¸Šä¼ å¤§å°é™åˆ¶
- ç¡®è®¤Spring Bootçš„æ–‡ä»¶ä¸Šä¼ é…ç½®

**Q3ï¼šå›¾ç‰‡æ˜¾ç¤ºä¸å‡ºæ¥**
- æ£€æŸ¥é™æ€èµ„æºæ˜ å°„é…ç½®ï¼ˆWebMvcConfigï¼‰
- ç¡®è®¤æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥æ–‡ä»¶æ˜¯å¦çœŸå®å­˜åœ¨
- éªŒè¯JWTæ‹¦æˆªå™¨æ˜¯å¦æ’é™¤äº†/files/**è·¯å¾„

**Q4ï¼šæ•°æ®åº“è·¯å¾„å­—æ®µé•¿åº¦ä¸å¤Ÿ**
- å»ºè®®VARCHAR(255)ï¼Œè¶³å¤Ÿå­˜å‚¨å®Œæ•´è·¯å¾„
- æ£€æŸ¥å­—æ®µå®šä¹‰å’Œå®é™…å­˜å‚¨å†…å®¹

**Q5ï¼šbaseUrlé…ç½®é—®é¢˜**
- ç¡®ä¿application.ymlä¸­é…ç½®äº†app.base-url
- æ£€æŸ¥Serviceå±‚æ˜¯å¦æ­£ç¡®æ³¨å…¥@Value("${app.base-url}")
- å¼€å‘ç¯å¢ƒé€šå¸¸ä½¿ç”¨http://localhost:8080

**Q6ï¼šæƒé™éªŒè¯å¤±è´¥**
- ç¡®è®¤Controlleræ–¹æ³•æ·»åŠ äº†@RequiresLoginæ³¨è§£
- æ£€æŸ¥JWT tokenæ˜¯å¦æœ‰æ•ˆ
- éªŒè¯UserContext.getCurrentUserId()æ˜¯å¦è¿”å›æ­£ç¡®å€¼

**Q7ï¼šå®ä½“ç±»IDç±»å‹ä¸Mapperæ³›å‹ä¸åŒ¹é…**
- ç¡®ä¿å®ä½“ç±»çš„IDç±»å‹ä¸Mapperæ¥å£çš„æ³›å‹å‚æ•°ä¸€è‡´
- ä¾‹å¦‚ï¼šChatSessionä½¿ç”¨String IDï¼Œåˆ™ChatSessionMapperåº”ä¸ºBaseMapper<ChatSession, String>
- åŒæ—¶æ£€æŸ¥XMLæ–‡ä»¶ä¸­çš„parameterTypeæ˜¯å¦åŒ¹é…
- è¿™æ˜¯åœºæ™¯3å®ç°ä¸­å®¹æ˜“é‡åˆ°çš„é—®é¢˜

### å®é™…å¼€å‘ç»éªŒ

**æ–‡ä»¶å­˜å‚¨æœ€ä½³å®è·µ**ï¼š
- æ•°æ®åº“å­˜å‚¨ç›¸å¯¹è·¯å¾„ï¼Œä¾¿äºåŸŸåå˜æ›´
- å‰ç«¯ä½¿ç”¨å®Œæ•´URLè¿›è¡Œè®¿é—®
- æ–‡ä»¶åä½¿ç”¨æ—¶é—´æˆ³+UUIDé¿å…å†²çª
- æŒ‰æ—¥æœŸåˆ†å±‚å­˜å‚¨ï¼Œä¾¿äºç®¡ç†

**é”™è¯¯å¤„ç†æœ€ä½³å®è·µ**ï¼š
- ä½¿ç”¨ç»Ÿä¸€çš„Resultè¿”å›æ ¼å¼
- è®°å½•è¯¦ç»†çš„æ—¥å¿—ä¿¡æ¯
- åŒºåˆ†ä¸šåŠ¡å¼‚å¸¸å’Œç³»ç»Ÿå¼‚å¸¸
- å‰ç«¯ä½¿ç”¨ç»Ÿä¸€çš„çŠ¶æ€ç æ¶ˆæ¯ç³»ç»Ÿ

**æ€§èƒ½ä¼˜åŒ–ç»éªŒ**ï¼š
- å¤§å›¾ç‰‡è‡ªåŠ¨å‹ç¼©ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- åˆç†çš„æ–‡ä»¶å¤§å°é™åˆ¶
- è€ƒè™‘CDNé›†æˆæå‡è®¿é—®é€Ÿåº¦

### æ€§èƒ½ä¼˜åŒ–

**å·²å®ç°çš„ä¼˜åŒ–**ï¼š
- è‡ªåŠ¨å›¾ç‰‡å‹ç¼©ï¼ˆ>1MBè§¦å‘ï¼‰
- æŒ‰æ—¥æœŸåˆ†å±‚å­˜å‚¨
- å®šæ—¶æ¸…ç†å­¤å„¿æ–‡ä»¶

**å¯è€ƒè™‘çš„ä¼˜åŒ–**ï¼š
- CDNåŠ é€Ÿ
- å›¾ç‰‡ç¼©ç•¥å›¾ç”Ÿæˆ
- å¼‚æ­¥ä¸Šä¼ å¤„ç†
- æ–‡ä»¶å»é‡

### å®‰å…¨è€ƒè™‘

**å·²å®ç°çš„å®‰å…¨æªæ–½**ï¼š
- æ–‡ä»¶ç±»å‹éªŒè¯
- æ–‡ä»¶å¤§å°é™åˆ¶
- è·¯å¾„éå†æ”»å‡»é˜²æŠ¤
- UUIDæ–‡ä»¶åé¿å…å†²çª

**å»ºè®®çš„å®‰å…¨æªæ–½**ï¼š
- å›¾ç‰‡å†…å®¹æ£€æµ‹
- ç—…æ¯’æ‰«æ
- è®¿é—®æƒé™æ§åˆ¶
- é˜²ç›—é“¾è®¾ç½®

---

## æ³¨æ„äº‹é¡¹

### å…³é”®åŸåˆ™

1. **typeåœ¨Serviceå±‚ç¡¬ç¼–ç **ï¼šæ¯ä¸ªæ¥å£çš„typeæ˜¯å›ºå®šçš„ï¼Œä¸ç”±å‰ç«¯ä¼ é€’
2. **ç»Ÿä¸€ä½¿ç”¨FileUploadUtils**ï¼šæ‰€æœ‰å›¾ç‰‡ä¸Šä¼ éƒ½é€šè¿‡å·¥å…·ç±»å¤„ç†
3. **ç›¸å¯¹è·¯å¾„å­˜æ•°æ®åº“**ï¼šä¾¿äºåŸŸåå˜æ›´å’Œæ–‡ä»¶è¿ç§»
4. **å®Œæ•´URLè¿”å›å‰ç«¯**ï¼šä¾¿äºå‰ç«¯ç›´æ¥ä½¿ç”¨

### å¼€å‘è§„èŒƒ

1. **æ–°å¢æ¥å£æ—¶**ï¼š
   - ç¡®å®štypeåˆ†ç±»
   - ç¡®å®šæ•°æ®åº“å­˜å‚¨æ–¹æ¡ˆ
   - æŒ‰ç…§æ¨¡æ¿å®ç°ä»£ç 
   - æ›´æ–°æœ¬æ–‡æ¡£

2. **ä¿®æ”¹å·¥å…·ç±»æ—¶**ï¼š
   - è€ƒè™‘å‘åå…¼å®¹æ€§
   - æ›´æ–°ç›¸å…³æ–‡æ¡£
   - æµ‹è¯•æ‰€æœ‰æ¥å£

3. **æ•°æ®åº“è®¾è®¡æ—¶**ï¼š
   - å›¾ç‰‡å­—æ®µä½¿ç”¨VARCHAR(255)
   - å¤šå›¾ç‰‡ä½¿ç”¨TEXTå­˜JSON
   - è€ƒè™‘æ˜¯å¦éœ€è¦ä¸“ç”¨å›¾ç‰‡è¡¨

### ç»™ AI çš„æç¤º

å¦‚æœä½ æ˜¯ AI æ¨¡å‹ï¼Œåœ¨å¤„ç†æ–‡ä»¶ä¸Šä¼ ç›¸å…³ä»»åŠ¡æ—¶ï¼š

1. **ç†è§£ä¸šåŠ¡åœºæ™¯**ï¼šåŒºåˆ†ä¸‰ç§ä¸åŒçš„ä¸šåŠ¡åœºæ™¯
2. **éµå¾ªç»Ÿä¸€æ–¹æ¡ˆ**ï¼šæ‰€æœ‰æ¥å£éƒ½ä½¿ç”¨ç›¸åŒçš„æŠ€æœ¯æ–¹æ¡ˆ
3. **ç¡¬ç¼–ç type**ï¼šåœ¨Serviceå±‚ç¡¬ç¼–ç ï¼Œä¸ç”±å‰ç«¯ä¼ é€’
4. **ä½¿ç”¨å·¥å…·ç±»**ï¼šå¿…é¡»é€šè¿‡FileUploadUtilså¤„ç†æ–‡ä»¶
5. **æ›´æ–°æ–‡æ¡£**ï¼šä¿®æ”¹ä»£ç ååŠæ—¶æ›´æ–°æœ¬æ–‡æ¡£

---

## å‚è€ƒèµ„æ–™

- **å·¥å…·ç±»å®ç°**ï¼š`src/main/java/com/shangnantea/utils/FileUploadUtils.java`
- **å®šæ—¶ä»»åŠ¡**ï¼š`src/main/java/com/shangnantea/task/FileCleanupTask.java`
- **æ•°æ®åº“è¡¨ç»“æ„**ï¼š`teasystem.sql`
- **APIæ¥å£å®šä¹‰**ï¼š`../../../openapi_new.yaml`
- **çŠ¶æ€ç æ˜ å°„**ï¼š`../../../shangnantea-web/docs/tasks/code-message-mapping.md`

---

**æœ€åæ›´æ–°**ï¼š2026-01-21  
**ç»´æŠ¤è€…**ï¼šé¡¹ç›®å›¢é˜Ÿ  
**åŸºäºå®ç°**ï¼šç”¨æˆ·å¤´åƒä¸Šä¼ ã€å›¾ç‰‡æ¶ˆæ¯å‘é€ã€è¯„ä»·å›¾ç‰‡ä¸Šä¼ ã€å¸–å­å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½å®Œæ•´å¼€å‘ç»éªŒ