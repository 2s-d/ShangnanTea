/**
 * API消息工具 - 基于状态码的消息映射
 * 
 * ⚠️ 重要：本文件必须与 docs/code-message-mapping.md 保持完全同步
 * 
 * 功能：
 * - 根据状态码获取对应消息
 * - 自动显示成功/错误消息
 * - 判断响应是否成功
 * - 静默状态码不显示消息（但记录日志）
 * 
 * 状态码规则：
 * - 200: HTTP成功（静默，不显示消息）
 * - x0xx: 业务成功码（需要显示消息，除非在静默列表中）
 * - x1xx: 业务失败码（需要显示消息）
 * 
 * 同步维护要求：
 * 1. CODE_MAP 必须包含文档中的所有状态码和消息
 * 2. SILENT_CODES 必须与文档中的 [静默] 标注完全一致
 * 3. 文档更新时，必须同步更新本文件
 * 4. 状态码去重：同一状态码只保留一个消息（四位数状态码足够分配，不会重复）
 * 
 * 数据来源：docs/code-message-mapping.md
 * 最后更新: 2026-01-13
 */

import { apiMessage } from './messageManager'

// ⚠️ 同步维护要求：
// 1. 本文档中的所有状态码和消息必须出现在 CODE_MAP 中
// 2. 文档中标注 [静默] 的状态码必须出现在 SILENT_CODES 中
// 3. 文档更新时，必须同步更新 CODE_MAP 和 SILENT_CODES
// 4. 状态码去重：同一状态码只保留一个消息（四位数状态码足够分配，不会重复）

// 静默状态码列表
// 这些状态码不会显示消息给用户，但会在开发环境记录日志
// ⚠️ 必须与 docs/code-message-mapping.md 中的 [静默] 标注完全一致
const SILENT_CODES = [
  // HTTP成功码（查询类接口）
  200,
  
  // 茶叶模块 - 查询类成功码
  3000,  // 茶叶列表加载成功
  3001,  // 茶叶详情加载成功
  
  // 用户模块 - 轻量级操作
  5001,  // 已取消关注
  
  // 茶叶模块 - 轻量级操作
  3011,  // 已取消收藏（茶叶）
  
  // 论坛模块 - 轻量级操作
  6011,  // 已取消点赞
  6013,  // 已取消收藏（帖子）
  
  // 消息模块 - 后台操作
  7010,  // 通知已标记为已读
  7011,  // 所有通知已标记为已读
]

// 状态码消息映射表
// ⚠️ 必须与 docs/code-message-mapping.md 文档完全同步
// 基于文档中的166个接口提取，每个状态码只保留一个消息
// 状态码去重：同一状态码在不同接口中出现时，消息应该一致（四位数状态码足够分配，不会重复）
export const CODE_MAP = {
  // ========== HTTP状态码 ==========
  200: '操作成功',
  400: '请求错误',
  401: '未认证',
  403: '无权限',
  404: '资源不存在',
  500: '服务器错误',

  // ========== 通用模块 (1xxx) ==========
  // 成功码 (1000-1049)
  1000: '操作成功',
  1001: '上传成功',
  1003: '删除成功',
  1004: '更新成功',
  
  // 错误码 (1100-1199)
  1100: '操作失败',
  1101: '上传失败',
  1102: '加载失败',
  1103: '不支持的文件类型',
  1104: '文件大小超限',

  // ========== 用户模块 (2xxx) ==========
  // 成功码 (2000-2049)
  2000: '登录成功',
  2001: '注册成功，请登录',
  2002: '已安全退出系统',
  2004: '密码重置成功',
  2010: '个人资料更新成功',
  2011: '密码修改成功，请使用新密码登录',
  2012: '头像更新成功',
  2013: '偏好设置更新成功',
  2020: '用户已删除',
  2021: '用户状态已修改',
  2022: '用户已更新',
  2023: '管理员已添加',
  
  // 错误码 (2100-2199)
  2100: '登录失败，请检查用户名和密码',
  2101: '注册失败',
  2102: '您的登录已过期，请重新登录',
  2103: '认证失败，请重新登录',
  2104: '密码重置失败',
  2105: '登录失败，服务器返回的Token无效',
  2110: '个人资料更新失败',
  2111: '密码修改失败，请检查原密码是否正确',
  2112: '头像更新失败',
  2113: '两次输入的密码不一致',
  2114: '偏好设置更新失败',
  2120: '获取用户列表失败',
  2121: '删除用户失败',
  2122: '修改用户状态失败',
  2123: '提交失败',
  2124: '您没有权限执行此操作',

  // ========== 茶叶模块 (3xxx) ==========
  // 成功码 (3000-3049)
  3000: '茶叶列表加载成功',
  3001: '茶叶详情加载成功',
  3010: '已收藏',
  3011: '已取消收藏',
  3013: '回复成功',
  3020: '上架成功',
  3021: '下架成功',
  3022: '批量上架成功',
  3023: '批量下架成功',
  3024: '删除成功',
  3025: '茶叶更新成功',
  3026: '茶叶添加成功',
  3030: '分类创建成功',
  3031: '分类更新成功',
  3032: '分类删除成功',
  
  // 错误码 (3100-3199)
  3100: '加载茶叶数据失败',
  3101: '加载茶叶详情失败',
  3110: '操作失败',
  3112: '回复失败',
  3113: '点赞失败',
  3120: '上架失败',
  3121: '下架失败',
  3122: '批量上架失败',
  3123: '批量下架失败',
  3124: '删除失败',
  3125: '操作失败',
  3130: '操作失败',
  3131: '删除分类失败',

  // ========== 订单模块 (4xxx) ==========
  // 成功码 (4000-4049)
  4000: '订单创建成功',
  4002: '订单已取消',
  4003: '确认收货成功',
  4004: '发货成功',
  4005: '订单已支付',
  4006: '批量发货成功',
  4010: '已加入购物车',
  4011: '商品数量已更新',
  4012: '规格已更新',
  4013: '商品已从购物车移除',
  4015: '购物车已清空',
  4020: '支付成功',
  4030: '退款申请已提交，等待商家审核',
  4031: '已同意退款申请',
  4032: '已拒绝退款申请',
  4050: '评价提交成功，感谢您的反馈',
  4060: '地址添加成功',
  
  // 错误码 (4100-4199)
  4100: '创建订单失败',
  4102: '取消订单失败',
  4103: '确认收货失败',
  4104: '发货失败',
  4105: '订单不存在',
  4106: '您没有权限操作此订单',
  4107: '获取订单详情失败',
  4108: '批量发货失败',
  4110: '获取购物车数据失败',
  4111: '加入购物车失败',
  4112: '更新数量失败',
  4113: '移除商品失败',
  4115: '清空购物车失败',
  4116: '商品库存不足',
  4117: '已达到购买数量上限',
  4118: '商品已下架或不可用',
  4120: '支付失败',
  4121: '支付已取消',
  4122: '支付超时，订单已自动取消',
  4124: '余额不足',
  4130: '退款申请提交失败',
  4131: '退款申请失败',
  4132: '获取退款详情失败',
  4140: '获取物流信息失败',
  4150: '评价提交失败',
  4160: '获取地址失败',
  4161: '保存地址失败',

  // ========== 店铺模块 (5xxx) ==========
  // 成功码 (5000-5049)
  5000: '已关注店铺',
  5001: '已取消关注',
  5002: '评价提交成功',
  5010: 'Banner添加成功',
  5011: 'Banner更新成功',
  5012: '删除成功',
  5013: '排序更新成功',
  5020: '公告添加成功',
  5021: '公告更新成功',
  5022: '删除成功',
  5030: 'Logo上传成功',
  
  // 错误码 (5100-5199)
  5100: '加载店铺信息失败',
  5101: '加载店铺数据失败',
  5102: '操作失败',
  5103: '加载评价失败',
  5104: '提交评价失败',
  5105: '店铺信息不存在',
  5110: '加载Banner列表失败',
  5111: '保存失败',
  5112: '删除失败',
  5113: '排序更新失败',
  5120: '加载公告列表失败',
  5121: '保存失败',
  5122: '删除失败',
  5130: 'Logo上传失败',

  // ========== 论坛模块 (6xxx) ==========
  // 成功码 (6000-6049)
  6000: '帖子发布成功',
  6001: '帖子更新成功',
  6002: '帖子删除成功',
  6010: '点赞成功',
  6011: '已取消点赞',
  6012: '收藏成功',
  6013: '已取消收藏',
  6021: '评论已删除',
  6022: '回复发布成功',
  6030: '帖子已置顶',
  6031: '帖子已取消置顶',
  6032: '帖子已加精',
  6033: '帖子已取消加精',
  6034: '帖子审核通过',
  6035: '帖子审核拒绝',
  6040: '添加版块成功',
  6041: '更新版块成功',
  6042: '删除版块成功',
  6050: '文章创建成功',
  6051: '文章更新成功',
  6052: '文章已删除',
  6060: '区块内容已保存',
  
  // 错误码 (6100-6199)
  6100: '帖子发布失败',
  6101: '帖子更新失败',
  6102: '帖子删除失败',
  6103: '获取帖子列表失败',
  6104: '获取帖子详情失败',
  6110: '点赞失败',
  6111: '取消点赞失败',
  6112: '收藏失败',
  6113: '取消收藏失败',
  6121: '评论删除失败',
  6122: '回复发布失败',
  6123: '获取回复列表失败',
  6130: '置顶失败',
  6131: '取消置顶失败',
  6132: '加精失败',
  6133: '取消加精失败',
  6134: '审核通过失败',
  6135: '审核拒绝失败',
  6136: '获取待审核帖子列表失败',
  6140: '添加版块失败',
  6141: '更新版块失败',
  6142: '删除版块失败',
  6143: '获取版块列表失败',
  6150: '文章创建失败',
  6151: '文章更新失败',
  6152: '文章删除失败',
  6153: '获取文章列表失败',
  6160: '获取首页数据失败',
  6161: '获取轮播图数据失败',
  6163: '保存失败',

  // ========== 消息模块 (7xxx) ==========
  // 成功码 (7000-7049)
  7000: '消息发送成功',
  7001: '会话已删除',
  7003: '图片上传成功',
  7010: '通知已标记为已读',
  7011: '所有通知已标记为已读',
  7012: '通知已删除',
  7013: '所有通知已清空',
  7014: '通知已置顶',
  
  // 错误码 (7100-7199)
  7100: '发送失败',
  7101: '加载失败',
  7103: '图片上传失败',
  7110: '标记已读失败',
  7120: '未能获取到用户信息',
  7121: '用户信息不完整',
}

/**
 * 根据状态码获取对应消息
 * @param {number} code - 状态码
 * @returns {string} 对应的消息文本
 */
export function getMessageByCode(code) {
  return CODE_MAP[code] || `未知状态码: ${code}`
}

/**
 * 根据状态码自动显示消息
 * @param {number} code - 状态码
 * @param {string} customMessage - 自定义消息（可选）
 * 
 * 处理流程：
 * 1. 检查是否为静默状态码 → 静默处理（开发环境记录日志，不显示消息）
 * 2. 获取消息文本
 * 3. 检查是否为未知状态码 → 警告处理（开发环境记录警告，不显示消息）
 * 4. 正常显示消息（成功/错误）
 */
export function showByCode(code, customMessage = null) {
  // 1. 检查是否为静默状态码
  if (SILENT_CODES.includes(code)) {
    // 静默码：开发环境记录日志，但不显示消息
    if (process.env.NODE_ENV === 'development') {
      const message = customMessage || getMessageByCode(code)
      console.log(`[静默] ${code}: ${message}`)
    }
    return  // 直接返回，不显示消息
  }
  
  // 2. 获取消息
  const message = customMessage || getMessageByCode(code)
  
  // 3. 未知状态码处理：不显示，但记录警告
  if (message.startsWith('未知状态码')) {
    if (process.env.NODE_ENV === 'development') {
      console.warn(`[警告] 未知状态码: ${code}`)
    }
    return
  }
  
  // 4. 正常显示消息
  if (isSuccess(code)) {
    apiMessage.success(message)
  } else {
    apiMessage.error(message)
  }
}

/**
 * 判断状态码是否表示成功
 * @param {number} code - 状态码
 * @returns {boolean} 是否成功
 * 
 * 状态码规则：
 * - 200: HTTP成功
 * - x0xx: 业务成功码（百位为0，如 6010, 6011, 6012）
 * - x1xx: 业务失败码（百位为1，如 6110, 6111, 6112）
 */
export function isSuccess(code) {
  // HTTP 200 成功
  if (code === 200) return true
  
  // 业务状态码：判断百位数字
  // x0xx = 成功（百位为0）
  // x1xx = 失败（百位为1）
  if (code >= 1000 && code <= 7999) {
    const hundredsDigit = Math.floor((code % 1000) / 100)
    return hundredsDigit === 0
  }
  
  return false
}

// 默认导出
export default {
  CODE_MAP,
  getMessageByCode,
  showByCode,
  isSuccess
}
