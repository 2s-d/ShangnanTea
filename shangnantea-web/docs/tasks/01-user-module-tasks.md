# 用户模块 (User Module) 任务分解

## 文档信息

| 项目 | 内容 |
|------|------|
| 模块名称 | 用户模块 (User Module) |
| 当前完成度 | 50% |
| 目标完成度 | 100% |
| 预计工时 | 3-4天 |
| 优先级 | 高 |
| 负责人 | - |
| 创建日期 | 2024-12-17 |
| 最后更新 | 2024-12-17 |

---

## 一、总体概览

### 1.1 模块职责

用户模块负责处理所有与用户相关的功能，包括：
- 用户认证（登录、注册、退出、Token管理）
- 个人资料管理（信息查看、编辑）
- 收货地址管理（增删改查、设置默认）
- 商家认证流程（申请、审核、状态查询）
- 用户互动功能（关注、收藏、点赞）
- 用户管理（管理员功能）

### 1.2 涉及文件

| 类型 | 文件路径 | 说明 |
|------|----------|------|
| Vuex | `src/store/modules/user.js` | 用户状态管理 |
| API | `src/api/user.js` | 用户API接口 |
| 常量 | `src/api/apiConstants.js` | API端点定义 |
| 工具 | `src/composables/useStorage.js` | Token存储 |
| 页面 | `src/views/user/auth/LoginPage.vue` | 登录页 |
| 页面 | `src/views/user/auth/RegisterPage.vue` | 注册页 |
| 页面 | `src/views/user/profile/ProfilePage.vue` | 个人中心 |
| 页面 | `src/views/user/settings/ProfileEditPage.vue` | 资料编辑 |
| 页面 | `src/views/user/settings/SettingsPage.vue` | 设置页 |
| 页面 | `src/views/user/address/AddressPage.vue` | 地址管理 |
| 页面 | `src/views/user/change-password/ChangePasswordPage.vue` | 修改密码 |
| 页面 | `src/views/user/auth/MerchantApplication.vue` | 商家认证 |
| 页面 | `src/views/user/manage/UserManagePage.vue` | 用户管理(管理员) |

### 1.3 已完成功能

- [x] 用户登录/注册/退出
- [x] Token管理（存储、刷新）
- [x] 获取/更新用户信息
- [x] 修改密码
- [x] 地址API接口定义
- [x] 商家认证API接口定义
- [x] 基础角色判断（isAdmin、isUser、isShop）

### 1.4 待完成功能

**按任务组分类**：

- [x] **任务组B**：地址管理Vuex集成（已完成，需验证端到端闭环）
- [ ] **任务组0**：认证与登录注册端到端闭环（登录/注册/退出/Token刷新/密码修改/密码找回）
- [ ] **任务组A**：个人资料管理端到端闭环（用户信息获取/更新/头像上传）
- [ ] **任务组C**：商家认证流程端到端闭环（申请/状态查询/审核）
- [ ] **任务组D**：用户互动功能端到端闭环（关注/收藏/点赞）
- [ ] **任务组E**：用户管理端到端闭环（管理员功能：用户列表/角色管理/状态控制/认证审核）
- [ ] **任务组F**：用户偏好设置端到端闭环（主题/字体等设置）

---

## 二、具体实施

### 2.0 端到端闭环开发模式（本模块采用）

> 本文档从此处开始采用 **端到端小范围闭环** 的开发方式，不再默认“UI 已完成后再补 API/Vuex”。
>
> **目标**：每一个任务组都至少完成一次“可跑通的数据流闭环”：
>
> ```
> UI（组件/页面） → Vuex Actions → API（src/api） → 后端 Controller（返回测试数据，不走 DB/Service） → 响应 → Vuex State → UI 渲染
> ```
>
> **闭环验收（每个任务组都要做的最小自检）**：
> - [ ] 前端可编译运行（无构建级别错误）
> - [ ] 该任务组相关页面不再本地伪成功（不 setTimeout + 本地改业务状态）
> - [ ] Vuex State 能被真实请求更新（不是 UI 层造数组）
> - [ ] 后端 Controller 能对应该任务组接口返回可用的测试数据结构（字段齐全、可渲染）
>
> **最终测试策略调整**：
> - 原“每个任务组开发完立即全量写用例并执行”的方式，调整为：**开发期以闭环自检为主**
> - **模块全部任务组完成后**，再集中进入“最终统一测试”（仍遵循 `00-testing-standard.md`，并把用例与数据沉淀到 `tests/`）

### 2.1 任务拆分

> **任务组划分原则**：
> - 每个任务组对应一个**完整的功能域**（如"登录注册"、"地址管理"），而非单个操作
> - 每个任务组必须完成**端到端闭环**：后端Controller测试数据 → 前端API → Vuex状态管理 → UI组件
> - 任务组之间可能存在依赖关系，需按优先级顺序开发
> - 每个任务组包含"闭环自检"验收标准

---

#### 任务组0：认证与登录注册端到端闭环（Controller → API → Vuex → UI） (优先级: 最高)

> **功能域**：用户登录、注册、退出、Token刷新、密码修改、密码找回  
> **说明**：登录/注册在"旧计划"中已完成过前端部分，但当前计划要求 **端到端闭环**，因此必须补齐后端 Controller 测试数据返回与前端闭环验收。

**涉及功能点**：
- 用户登录（手机号/用户名）
- 用户注册（手机号/用户名）
- 退出登录
- Token刷新
- 密码修改
- 密码找回

**涉及页面**：
- `LoginPage.vue` - 登录页
- `RegisterPage.vue` - 注册页
- `ChangePasswordPage.vue` - 修改密码页
- 密码找回页（如未存在需创建）

**涉及后端接口**：
- `POST /user/login` - 登录
- `POST /user/register` - 注册
- `POST /user/logout` - 退出
- `POST /user/refresh` - 刷新Token
- `PUT /user/password` - 修改密码
- `POST /user/password/reset` - 密码找回（需确认端点）

**任务清单**：

| 任务ID | 任务描述 | 预计时间 | 状态 |
|--------|----------|----------|------|
| 0-0 | **后端 Controller**：登录/注册/退出/刷新Token/修改密码/密码找回接口返回测试数据（不走Service/DB，返回 token + userInfo） | 90min | ⬜ 待开始 |
| 0-1 | **前端工具层**：确认路由守卫/请求拦截器 token 流程使用 `useTokenStorage`（禁止直接 tokenUtils） | 20min | ⬜ 待开始 |
| 0-2 | **前端 API层**：确认 `src/api/user.js` 登录/注册/退出/刷新Token/修改密码/密码找回方法与 `apiConstants.js` 一致 | 30min | ⬜ 待开始 |
| 0-3 | **Vuex层**：确认 `src/store/modules/user.js` 的 login/register/logout/initAuth/changePassword 可在真实请求下更新 state（移除UI-DEV伪成功逻辑） | 60min | ⬜ 待开始 |
| 0-4 | **Vuex层**：实现 findPassword action（密码找回） | 30min | ⬜ 待开始 |
| 0-5 | **UI层**：`LoginPage.vue`/`RegisterPage.vue` 可完成登录/注册，登录后路由守卫放行并可进入受保护页面 | 40min | ⬜ 待开始 |
| 0-6 | **UI层**：`ChangePasswordPage.vue` 改为 dispatch Vuex action（不本地伪成功） | 30min | ⬜ 待开始 |
| 0-7 | **UI层**：密码找回页面（如未存在则创建）改为 dispatch Vuex action | 60min | ⬜ 待开始 |
| 0-8 | **闭环自检**：登录→刷新页面仍保持登录态；退出后受保护页面被拦截并跳转登录；密码修改/找回流程可完成 | 40min | ⬜ 待开始 |

**注意事项**：
- Token结构必须符合项目规范（类JWT：`base64Payload.signature`，包含 userId、username、role、exp）
- 路由守卫必须基于 token 验证，使用 `useTokenStorage.verifyToken()`
- 所有UI层操作必须通过 Vuex Actions，禁止本地 setTimeout 伪成功
- 密码找回流程需确认：是否需要手机验证码？是否需要邮箱验证？

**任务组0端到端闭环验收（开发期自检）**：
- [ ] 后端 Controller 返回的 `token` 可被前端存储并通过拦截器附加到请求头
- [ ] 路由守卫基于 token 校验放行/拦截正确
- [ ] Vuex `user` 状态与 UI 展示一致（NavBar/个人页可正确显示用户信息或空态）
- [ ] 全流程无"UI 本地伪登录成功"（不 setTimeout、不直接写死 userInfo）
- [ ] 密码修改/找回流程可完成，错误提示正确

---

#### 任务组A：个人资料管理端到端闭环（Controller → API → Vuex → UI） (优先级: 高)

> **功能域**：用户信息获取/更新、头像上传、个人简介设置、联系方式管理  
> **说明**：个人资料管理是用户模块的基础功能，与认证流程紧密相关。

**涉及功能点**：
- 获取用户信息（当前用户/指定用户）
- 更新用户信息（姓名、性别、生日、简介等）
- 头像上传与修改
- 联系方式管理（手机号、邮箱）

**涉及页面**：
- `ProfilePage.vue` - 个人中心（展示）
- `ProfileEditPage.vue` - 资料编辑页
- `SettingsPage.vue` - 设置页（可能包含联系方式管理）

**涉及后端接口**：
- `GET /user/me` - 获取当前用户信息
- `GET /user/{userId}` - 获取指定用户信息
- `PUT /user/` - 更新用户信息
- `POST /user/avatar` - 上传头像（需确认端点）

**任务清单**：

| 任务ID | 任务描述 | 预计时间 | 状态 |
|--------|----------|----------|------|
| A-0 | **后端 Controller**：用户信息获取/更新/头像上传接口返回测试数据（不走Service/DB） | 60min | ⬜ 待开始 |
| A-1 | **前端 API层**：确认 `src/api/user.js` 用户信息相关方法与 `apiConstants.js` 一致，补齐头像上传方法 | 30min | ⬜ 待开始 |
| A-2 | **Vuex层**：确认 `src/store/modules/user.js` 的 getUserInfo/updateUserInfo 可在真实请求下更新 state | 30min | ⬜ 待开始 |
| A-3 | **Vuex层**：实现 uploadAvatar action（头像上传，需处理文件上传） | 40min | ⬜ 待开始 |
| A-4 | **UI层**：`ProfilePage.vue` 改为从 Vuex 读取 userInfo（不本地造数据） | 30min | ⬜ 待开始 |
| A-5 | **UI层**：`ProfileEditPage.vue` 改为 dispatch Vuex updateUserInfo/uploadAvatar（不本地伪成功） | 60min | ⬜ 待开始 |
| A-6 | **闭环自检**：个人中心可正确展示用户信息；编辑资料/上传头像可完成并刷新状态 | 30min | ⬜ 待开始 |

**注意事项**：
- 头像上传需使用 `FormData` 格式，后端需支持文件上传
- 用户信息更新需做字段验证（如手机号格式、邮箱格式）
- 头像上传成功后需更新 Vuex state 中的 `userInfo.avatar` 字段
- 个人简介、联系方式等字段需确认数据库字段名（参考数据库设计文档）

**任务组A端到端闭环验收（开发期自检）**：
- [ ] UI 不本地造用户信息数据（信息来自 Vuex `state.user.userInfo`）
- [ ] Vuex Actions 通过 API 发请求获取/更新用户信息
- [ ] 后端 Controller 能返回用户信息/更新结果的测试数据结构
- [ ] 头像上传可选择文件并得到返回URL后更新 Vuex/UI
- [ ] 页面可完成：信息展示、编辑保存、头像上传（失败时提示错误，不伪成功）

---

#### 任务组B：收货地址管理端到端闭环（Controller → API → Vuex → UI） (优先级: 高)

> **功能域**：收货地址的增删改查、设置默认地址  
> **说明**：地址管理是订单流程的必要依赖，需优先完成。

**涉及功能点**：
- 获取地址列表
- 添加地址
- 更新地址
- 删除地址
- 设置默认地址

**涉及页面**：
- `AddressPage.vue` - 地址管理页

**涉及后端接口**：
- `GET /user/addresses` - 获取地址列表
- `POST /user/addresses` - 添加地址
- `PUT /user/addresses/{id}` - 更新地址
- `DELETE /user/addresses/{id}` - 删除地址
- `PUT /user/addresses/{id}/default` - 设置默认地址（需确认端点）

**任务清单**：

| 任务ID | 任务描述 | 预计时间 | 状态 |
|--------|----------|----------|------|
| B-0 | **后端 Controller**：地址相关接口返回测试数据（不走Service/DB，用于前端闭环验收） | 40min | ✅ 已具备 |
| B-1 | **Vuex层**：确认 `src/store/modules/user.js` 的地址相关 state/mutations/actions 已实现 | 10min | ✅ 已完成 |
| B-2 | **UI层**：确认 `AddressPage.vue` 已集成 Vuex（不本地造数据） | 10min | ✅ 已完成 |
| B-3 | **闭环自检**：地址列表可加载、增删改查/设置默认可触发请求并刷新 Vuex 状态 | 20min | ⬜ 待验证 |

**注意事项**：
- 地址字段需与数据库设计文档一致（province、city、district、detail等）
- 省市区选择器需使用 Element Plus 的 `ElCascader` 组件，数据源使用 `element-china-area-data`
- 设置默认地址时，需确保只有一个默认地址（后端需处理其他地址的 isDefault 字段）
- 删除默认地址时，需确认业务逻辑（是否禁止删除？或删除后自动设置第一个为默认？）

**任务组B端到端闭环验收（开发期自检）**：
- [x] UI 不本地造地址列表数据（列表来自 Vuex `state.user.addressList`）
- [x] Vuex Actions 通过 API 发请求获取/更新地址
- [x] 后端 Controller 能返回地址列表/新增/编辑/删除/默认地址的测试数据结构
- [x] 页面可完成：列表展示、编辑/删除/默认切换（失败时提示错误，不伪成功）

---

#### 任务组C：商家认证流程端到端闭环（Controller → API → Vuex → UI） (优先级: 中)

> **功能域**：商家认证申请、认证状态查询、管理员审核（审核部分在用户管理中）  
> **说明**：商家认证是普通用户升级为商家的关键流程，涉及用户角色变更。

**涉及功能点**：
- 提交商家认证申请（提交认证材料：身份证、营业执照等）
- 获取商家认证状态
- 管理员审核认证申请（在任务组E中实现）
- 确认认证通知（在消息模块中处理）

**涉及页面**：
- `MerchantApplication.vue` - 商家认证申请页
- 用户管理页（管理员审核，在任务组E中）

**涉及后端接口**：
- `POST /user/shop-certification` - 提交认证申请
- `GET /user/shop-certification` - 获取认证状态
- `GET /admin/certifications` - 获取认证申请列表（管理员，在任务组E中）
- `PUT /admin/certifications/{id}` - 审核认证申请（管理员，在任务组E中）

**任务清单**：

| 任务ID | 任务描述 | 预计时间 | 状态 |
|--------|----------|----------|------|
| C-0 | **后端 Controller**：商家认证申请/状态查询接口返回测试数据（不走Service/DB） | 50min | ⬜ 待开始 |
| C-1 | **前端 API层**：确认 `src/api/user.js` 商家认证相关方法与 `apiConstants.js` 一致 | 20min | ⬜ 待开始 |
| C-2 | **Vuex层**：确认 `src/store/modules/user.js` 的 submitShopCertification/fetchShopCertificationStatus 可在真实请求下更新 state | 30min | ⬜ 待开始 |
| C-3 | **UI层**：`MerchantApplication.vue` 改为 dispatch Vuex action（不本地伪成功） | 40min | ⬜ 待开始 |
| C-4 | **UI层**：个人中心显示认证状态（待审核/已通过/已拒绝），可跳转申请页 | 30min | ⬜ 待开始 |
| C-5 | **闭环自检**：认证申请可提交、状态可查询、UI正确展示状态 | 30min | ⬜ 待开始 |

**注意事项**：
- 认证材料上传需使用文件上传功能（身份证、营业执照等）
- 认证状态需与消息模块联动（审核结果通知）
- 认证通过后，用户角色变更为商家（role=3），系统自动创建店铺（在店铺模块中处理）
- 认证被拒绝后，用户可修改材料重新提交

**任务组C端到端闭环验收（开发期自检）**：
- [ ] UI 不本地造认证状态数据（状态来自 Vuex 或 API）
- [ ] Vuex Actions 通过 API 发请求提交申请/查询状态
- [ ] 后端 Controller 能返回认证申请/状态查询的测试数据结构
- [ ] 页面可完成：提交申请、查询状态、展示状态（失败时提示错误，不伪成功）

---

#### 任务组D：用户互动功能端到端闭环（关注/收藏/点赞）（Controller → API → Vuex → UI） (优先级: 高)

> **功能域**：用户关注（用户/店铺）、收藏（商品/帖子/文章）、点赞（帖子/评论）  
> **说明**：用户互动功能是社区活跃度的核心，涉及多个模块的联动。

**涉及功能点**：
- 关注用户/店铺
- 取消关注
- 收藏商品/帖子/文章
- 取消收藏
- 点赞内容（帖子/评论）
- 取消点赞

**涉及页面**：
- `FollowsPage.vue` - 关注列表页（消息模块）
- `FavoritesPage.vue` - 收藏列表页（消息模块）
- `TeaDetailPage.vue` - 茶叶详情页（收藏按钮）
- `ShopDetailPage.vue` - 店铺详情页（关注按钮）
- `UserHomePage.vue` - 个人主页（关注按钮）
- `ForumDetailPage.vue` - 论坛详情页（收藏/点赞按钮）

**涉及后端接口**：
- `GET /user/follows` - 获取关注列表（支持 type 参数：user/shop）
- `POST /user/follows` - 添加关注
- `DELETE /user/follows/{id}` - 取消关注
- `GET /user/favorites` - 获取收藏列表（支持 type 参数：tea/post/article）
- `POST /user/favorites` - 添加收藏
- `DELETE /user/favorites/{id}` - 取消收藏
- `POST /user/likes` - 点赞（需确认端点）
- `DELETE /user/likes/{id}` - 取消点赞（需确认端点）

**任务清单**：

| 任务ID | 任务描述 | 预计时间 | 状态 |
|--------|----------|----------|------|
| D-0 | **后端 Controller**：关注/收藏/点赞接口返回测试数据（不走Service/DB） | 80min | ⬜ 待开始 |
| D-1 | **前端 API层**：在 `src/api/user.js` 添加关注/收藏/点赞相关方法（get/add/remove） | 60min | ⬜ 待开始 |
| D-2 | **Vuex层**：在 `src/store/modules/user.js` 添加 followList/favoriteList/likeList state | 30min | ⬜ 待开始 |
| D-3 | **Vuex层**：添加关注/收藏/点赞相关 mutations（SET_FOLLOW_LIST/SET_FAVORITE_LIST等） | 40min | ⬜ 待开始 |
| D-4 | **Vuex层**：实现 fetchFollowList/addFollow/removeFollow actions | 50min | ⬜ 待开始 |
| D-5 | **Vuex层**：实现 fetchFavoriteList/addFavorite/removeFavorite actions | 50min | ⬜ 待开始 |
| D-6 | **Vuex层**：实现点赞相关 actions（如需要） | 40min | ⬜ 待开始 |
| D-7 | **UI层**：`FollowsPage.vue` 改为 Vuex 驱动列表 + dispatch 取消关注 | 40min | ⬜ 待开始 |
| D-8 | **UI层**：`FavoritesPage.vue` 改为 Vuex 驱动列表 + dispatch 取消收藏 | 40min | ⬜ 待开始 |
| D-9 | **UI层联动**：`TeaDetailPage.vue` 收藏按钮改为 dispatch（不本地改状态） | 30min | ⬜ 待开始 |
| D-10 | **UI层联动**：`ShopDetailPage.vue` 关注店铺按钮改为 dispatch | 30min | ⬜ 待开始 |
| D-11 | **UI层联动**：`UserHomePage.vue` 关注按钮改为 dispatch | 30min | ⬜ 待开始 |
| D-12 | **UI层联动**：`ForumDetailPage.vue` 收藏/点赞按钮改为 dispatch | 40min | ⬜ 待开始 |
| D-13 | **闭环自检**：关注/收藏/点赞列表可加载、操作可触发请求并刷新 Vuex 状态 | 40min | ⬜ 待开始 |

**注意事项**：
- 关注/收藏/点赞需要支持多种类型（targetType：user/shop/tea/post/article），后端需统一处理
- 关注列表需区分用户和店铺，UI需支持分类展示
- 收藏列表需区分商品/帖子/文章，UI需支持分类筛选
- 点赞功能可能涉及论坛模块，需确认是否在用户模块统一管理
- 所有互动操作需实时更新 Vuex 状态，避免页面刷新后状态丢失

**任务组D端到端闭环验收（开发期自检）**：
- [ ] UI 不本地造关注/收藏/点赞列表数据（列表来自 Vuex）
- [ ] Vuex Actions 通过 API 发请求获取/更新互动数据
- [ ] 后端 Controller 能返回关注/收藏/点赞的测试数据结构
- [ ] 页面可完成：列表展示、添加/取消操作（失败时提示错误，不伪成功）
- [ ] 各联动页面（茶叶详情、店铺详情、个人主页、论坛详情）的按钮可正确触发操作

---

#### 任务组E：用户管理端到端闭环（管理员功能）（Controller → API → Vuex → UI） (优先级: 中)

> **功能域**：管理员对用户的管理（用户列表、角色管理、状态控制、商家认证审核）  
> **说明**：用户管理是管理员专用功能，需严格权限控制。

**涉及功能点**：
- 用户列表查看与搜索
- 用户角色管理（修改用户角色）
- 账户状态控制（启用/禁用账户）
- 用户行为统计（可选）
- 商家认证申请处理（审核认证申请）

**涉及页面**：
- `UserManagePage.vue` - 用户管理页（管理员）

**涉及后端接口**：
- `GET /admin/users` - 获取用户列表（支持搜索、分页、筛选）
- `PUT /admin/users/{userId}/role` - 更新用户角色
- `PUT /admin/users/{userId}/status` - 启用/禁用用户
- `GET /admin/users/statistics` - 获取用户行为统计（可选）
- `GET /admin/certifications` - 获取商家认证申请列表
- `PUT /admin/certifications/{id}` - 审核认证申请（通过/拒绝）

**任务清单**：

| 任务ID | 任务描述 | 预计时间 | 状态 |
|--------|----------|----------|------|
| E-0 | **后端 Controller**：管理员用户管理接口返回测试数据（用户列表/角色/状态/认证审核，不走Service/DB） | 90min | ⬜ 待开始 |
| E-1 | **前端 API层**：在 `src/api/user.js` 添加管理员用户管理方法（getUserList/updateUserRole/toggleUserStatus/getCertificationList/processCertification） | 60min | ⬜ 待开始 |
| E-2 | **Vuex层**：在 `src/store/modules/user.js` 添加 userList / userPagination / filters / certificationList state | 30min | ⬜ 待开始 |
| E-3 | **Vuex层**：添加用户管理相关 mutations（SET_USER_LIST/SET_PAGINATION/SET_FILTERS/SET_CERTIFICATION_LIST等） | 40min | ⬜ 待开始 |
| E-4 | **Vuex层**：实现 fetchUserList / updateUserRole / toggleUserStatus / fetchCertificationList / processCertification actions | 80min | ⬜ 待开始 |
| E-5 | **UI层**：`UserManagePage.vue` 改为 Vuex 驱动列表、筛选、分页；按钮只 dispatch | 90min | ⬜ 待开始 |
| E-6 | **权限校验**：非管理员访问/操作应被拦截（路由meta + 守卫 + 后端返回403） | 40min | ⬜ 待开始 |
| E-7 | **闭环自检**：管理员列表可加载、角色变更/禁用启用/审核操作可触发请求并刷新 Vuex 状态 | 40min | ⬜ 待开始 |

**注意事项**：
- 所有管理员接口需在路由守卫和API拦截器中检查用户角色（role=1）
- 用户列表需支持搜索（用户名/手机号）、筛选（角色/状态）、分页
- 角色管理需确认可切换的角色范围（普通用户↔商家，管理员不可被修改）
- 商家认证审核需与任务组C联动（审核通过后，用户角色变更为商家，系统自动创建店铺）
- 用户行为统计功能需确认是否在本次开发范围内（如不在，可标记为"后续扩展"）

**任务组E端到端闭环验收（开发期自检）**：
- [ ] UI 不本地造用户列表数据（列表来自 Vuex `state.user.userList`）
- [ ] Vuex Actions 通过 API 发请求获取/更新用户数据
- [ ] 后端 Controller 能返回用户列表/角色/状态/认证审核的测试数据结构
- [ ] 页面可完成：列表展示、搜索筛选、角色变更、状态控制、认证审核（失败时提示错误，不伪成功）
- [ ] 非管理员访问/操作被正确拦截（路由守卫 + 后端403）

---

#### 任务组F：用户偏好设置端到端闭环（Controller → API → Vuex → UI） (优先级: 低)

> **功能域**：用户偏好设置（主题/展示等）  
> **说明**：用户偏好设置是增强用户体验的功能，优先级较低，可在其他核心功能完成后实现。

**涉及功能点**：
- 获取用户偏好设置（主题、字体、动画等）
- 更新用户偏好设置

**涉及页面**：
- `SettingsPage.vue` - 设置页（可能包含偏好设置）

**涉及后端接口**：
- `GET /user/preferences` - 获取用户偏好设置
- `PUT /user/preferences` - 更新用户偏好设置

**任务清单**：

| 任务ID | 任务描述 | 预计时间 | 状态 |
|--------|----------|----------|------|
| F-0 | **后端 Controller**：用户偏好设置接口返回测试数据（不走Service/DB） | 30min | ⬜ 待开始 |
| F-1 | **前端 API层**：确认 `src/api/user.js` 偏好设置相关方法与 `apiConstants.js` 一致 | 20min | ⬜ 待开始 |
| F-2 | **Vuex层**：确认 `src/store/modules/user.js` 的 fetchUserPreferences/saveUserPreferences 可在真实请求下更新 state | 30min | ⬜ 待开始 |
| F-3 | **UI层**：`SettingsPage.vue` 改为从 Vuex 读取 preferences，保存时 dispatch action | 40min | ⬜ 待开始 |
| F-4 | **闭环自检**：偏好设置可加载、保存后可刷新状态并应用到UI | 20min | ⬜ 待开始 |

**注意事项**：
- 偏好设置需在用户登录后自动加载并应用到UI（主题、字体等）
- 偏好设置变更需实时生效（无需刷新页面）
- 偏好设置字段需与数据库设计文档一致（theme、fontSize、fontFamily等）

**任务组F端到端闭环验收（开发期自检）**：
- [ ] UI 不本地造偏好设置数据（数据来自 Vuex `state.user.preferences`）
- [ ] Vuex Actions 通过 API 发请求获取/更新偏好设置
- [ ] 后端 Controller 能返回偏好设置的测试数据结构
- [ ] 页面可完成：设置展示、保存更新（失败时提示错误，不伪成功）
- [ ] 偏好设置变更可实时应用到UI（主题切换、字体大小等）

---

### 2.2 Mock数据设计

#### 地址Mock数据
```javascript
const mockAddresses = [
  {
    id: 1,
    userId: 1,
    receiver: '张三',
    phone: '13800138000',
    province: '陕西省',
    city: '商洛市',
    district: '商南县',
    address: '城关镇XX路XX号',
    isDefault: true,
    createTime: '2024-01-01 10:00:00'
  }
  // ...更多地址
]
```

#### 收藏Mock数据
```javascript
const mockFavorites = [
  {
    id: 1,
    userId: 1,
    targetId: 101,
    targetType: 'tea',
    targetInfo: {
      name: '商南绿茶',
      price: 198,
      image: '/images/tea1.jpg'
    },
    createTime: '2024-01-15 14:30:00'
  }
  // ...更多收藏
]
```

#### 关注Mock数据
```javascript
const mockFollows = {
  users: [
    {
      id: 1,
      userId: 1,
      targetId: 2,
      targetType: 'user',
      targetInfo: {
        username: '茶艺大师',
        avatar: '/avatars/user2.jpg',
        bio: '专注茶艺20年'
      },
      createTime: '2024-01-10 09:00:00'
    }
  ],
  shops: [
    {
      id: 2,
      userId: 1,
      targetId: 101,
      targetType: 'shop',
      targetInfo: {
        shopName: '商南茶庄',
        logo: '/shops/shop1.jpg',
        description: '正宗商南茶叶'
      },
      createTime: '2024-01-12 11:00:00'
    }
  ]
}
```

---

### 2.3 开发顺序

**推荐开发顺序**：**0 → A → B → C → D → E → F**

**理由**：
1. **任务组0（认证与登录注册）**：最高优先级，是其他所有功能的基础，必须先完成端到端闭环
2. **任务组A（个人资料管理）**：高优先级，用户信息是系统核心数据，需在认证后立即可用
3. **任务组B（收货地址管理）**：高优先级，是订单流程的必要依赖，已部分完成，需验证闭环
4. **任务组C（商家认证流程）**：中优先级，涉及用户角色变更，需在个人资料管理后完成
5. **任务组D（用户互动功能）**：高优先级，是社区活跃度的核心，但依赖认证和个人资料
6. **任务组E（用户管理）**：中优先级，管理员专用功能，相对独立，可在核心功能完成后实现
7. **任务组F（用户偏好设置）**：低优先级，增强用户体验的功能，可最后完成

**注意事项**：
- 每个任务组必须完成端到端闭环后才能进入下一个任务组
- 任务组之间存在依赖关系时，需按顺序开发
- 开发过程中如发现任务组划分不合理，可及时调整

---

## 三、最终统一测试（模块全部功能完成后执行）

> **测试章程**: 请先阅读 `00-testing-standard.md` 了解测试标准流程和验收标准。

> **⚠️ 重要说明**：  
> - **2024-12-17 测试方案验证阶段**：已验证测试章程与记录方式可行  
> - **策略更新（端到端开发）**：开发期以“任务组闭环自检”为主；**模块全部任务组完成后**再集中执行本章“最终统一测试”  
> - **用例与数据位置**：最终用例/数据沉淀到 `tests/`（见 `tests/README.md`），本章保留“可执行用例文本”作为验收依据与复用模板

### 3.0 测试环境准备

```bash
# 1. 启动开发服务器
cd shangnantea/shangnantea-web
npm run serve

# 2. 等待编译完成，记录端口号（通常是8082）
# 3. 打开浏览器访问: http://localhost:8082
# 4. 打开浏览器开发者工具（F12）
# 5. 安装并启用Vue DevTools扩展
```

### 3.1 任务组A测试用例：地址管理

#### 测试用例A-T1：获取地址列表

**前置条件**：
- [ ] 开发服务器已启动
- [ ] 已登录系统

**测试步骤**：
1. 在浏览器地址栏输入: `http://localhost:8082/user/address`
2. 等待页面加载完成
3. 打开Vue DevTools → Vuex标签

**预期结果**：
- 页面显示地址列表（应有2条Mock数据：张三、李四）
- 第一条地址显示"默认"标签
- 控制台无Error级别错误

**Vuex状态检查**（在控制台执行）：
```javascript
// 获取store
const store = document.querySelector('#app').__vue_app__.config.globalProperties.$store
// 检查地址列表
console.log('地址列表:', store.state.user.addressList)
// 预期：数组长度>=2，包含张三和李四的地址
```

**验收标准**：
- [x] 页面正常加载，无白屏
- [x] 地址列表显示正确
- [ ] 控制台无Error（有1个错误但不影响功能）
- [x] Vuex状态正确（addressList有数据）

**实际结果**：
- ✅ 页面正常加载（URL: `/user/address`）
- ✅ 显示了2条地址数据（2个地址卡片，有"编辑/删除"按钮）
- ✅ 第一条地址是默认地址（没有"设为默认"按钮）
- ⚠️ 控制台有1个Error级别错误（messageManager.js中的message[type]调用问题，但不影响功能）
- ✅ Vuex状态正确（开发环境使用Mock数据，功能正常）

**状态**：✅ 通过（功能正常，但有需要修复的错误）  
**测试日期**：2024-12-17

---

#### 测试用例A-T2：添加新地址

**前置条件**：
- [ ] 已完成A-T1
- [ ] 当前在地址管理页面

**测试步骤**：
1. 点击"新增地址"按钮
2. 填写表单：
   - 收货人: `测试用户`
   - 手机号: `13800138001`
   - 所在地区: 选择 `陕西省` → `商洛市` → `商南县`
   - 详细地址: `测试街道123号`
   - 默认地址: 不勾选
3. 点击"保存"按钮
4. 检查Vue DevTools中Vuex状态变化

**预期结果**：
- 保存成功提示
- 弹窗关闭
- 地址列表新增一条记录
- 新地址不显示"默认"标签

**Vuex状态检查**：
```javascript
const store = document.querySelector('#app').__vue_app__.config.globalProperties.$store
console.log('添加后地址列表:', store.state.user.addressList)
// 预期：数组长度比之前+1，最后一条是刚添加的地址
```

**验收标准**：
- [ ] 表单提交成功（❌ 失败：省市区选择器未正确选择，表单验证失败）
- [ ] 弹窗正常关闭（❌ 失败：表单验证失败导致弹窗无法关闭）
- [ ] 列表自动刷新（❌ 未执行：保存未成功）
- [ ] Vuex状态正确更新（❌ 未执行：保存未成功）

**实际结果**：
- ❌ 表单提交失败：省市区选择器虽然显示了省份列表，但选择后未正确触发二级菜单（市），导致表单验证失败
- ❌ 弹窗未关闭：点击保存按钮后，由于表单验证失败，弹窗仍然打开
- ⚠️ 收货人、手机号、详细地址字段填写正常
- ⚠️ 默认地址开关可以正常切换
- ⚠️ 省市区选择器显示正常，但选择交互存在问题

**问题分析**：
- 省市区选择器（ElCascader）的交互可能存在问题，需要进一步检查组件配置
- 表单验证逻辑可能过于严格，需要检查验证规则

**状态**：❌ 部分失败（表单填写正常，但保存失败）  
**测试日期**：2024-12-17

---

#### 测试用例A-T3：编辑地址

**前置条件**：
- [ ] 地址列表至少有1条数据

**测试步骤**：
1. 找到一条非默认地址
2. 点击该地址的"编辑"按钮
3. 修改收货人为: `编辑测试`
4. 修改详细地址为: `编辑后的地址999号`
5. 点击"保存"按钮

**预期结果**：
- 表单预填充原地址数据
- 保存成功后列表显示更新后的信息
- 其他地址不受影响

**Vuex状态检查**：
```javascript
const store = document.querySelector('#app').__vue_app__.config.globalProperties.$store
const editedAddr = store.state.user.addressList.find(a => a.name === '编辑测试')
console.log('编辑后的地址:', editedAddr)
// 预期：找到地址，且详细地址为"编辑后的地址999号"
```

**验收标准**：
- [ ] 编辑表单预填充正确
- [ ] 保存成功
- [ ] 列表显示更新
- [ ] Vuex状态正确（UPDATE_ADDRESS mutation被触发）

**实际结果**：_____________  
**状态**：⬜ 通过 / ⬜ 失败  
**测试日期**：_____________

---

#### 测试用例A-T4：设置默认地址

**前置条件**：
- [ ] 地址列表至少有2条数据
- [ ] 当前有一条默认地址

**测试步骤**：
1. 找到一条**非默认**地址（没有"默认"标签的）
2. 点击该地址的"设为默认"按钮
3. 确认操作（如有确认弹窗）

**预期结果**：
- 操作成功提示
- 该地址显示"默认"标签
- **之前的默认地址"默认"标签消失**
- 列表中只有一条地址显示"默认"

**Vuex状态检查**：
```javascript
const store = document.querySelector('#app').__vue_app__.config.globalProperties.$store
console.log('默认地址ID:', store.state.user.defaultAddressId)
console.log('默认地址:', store.getters['user/defaultAddress'])
// 预期：defaultAddressId是刚设置的那条地址的ID
```

**验收标准**：
- [ ] 设置成功
- [ ] UI正确显示默认标签
- [ ] 只有一条默认地址
- [ ] Vuex状态正确（SET_DEFAULT_ADDRESS mutation被触发）

**实际结果**：_____________  
**状态**：⬜ 通过 / ⬜ 失败  
**测试日期**：_____________

---

#### 测试用例A-T5：删除地址

**前置条件**：
- [ ] 地址列表至少有2条数据

**测试步骤**：
1. 找到一条**非默认**地址
2. 点击"删除"按钮
3. 在确认弹窗中点击"确定"
4. 观察列表变化

**预期结果**：
- 删除成功提示
- 该地址从列表中消失
- 其他地址不受影响
- 列表数量-1

**Vuex状态检查**：
```javascript
const store = document.querySelector('#app').__vue_app__.config.globalProperties.$store
console.log('删除后地址列表长度:', store.state.user.addressList.length)
// 预期：比删除前少1
```

**验收标准**：
- [ ] 删除成功
- [ ] 列表正确更新
- [ ] 其他地址不受影响
- [ ] Vuex状态正确（REMOVE_ADDRESS mutation被触发）

**实际结果**：_____________  
**状态**：⬜ 通过 / ⬜ 失败  
**测试日期**：_____________

---

#### 测试用例A-T6：表单验证

**前置条件**：
- [ ] 当前在地址管理页面

**测试步骤**：
1. 点击"新增地址"按钮
2. **不填写任何内容**
3. 直接点击"保存"按钮

**预期结果**：
- 表单不提交
- 显示验证错误提示：
  - 收货人: "请输入收货人姓名"
  - 手机号: "请输入手机号码"
  - 所在地区: "请选择所在地区"
  - 详细地址: "请输入详细地址"

**验收标准**：
- [ ] 表单未提交
- [ ] 各字段显示错误提示
- [ ] 错误提示文案正确

**实际结果**：_____________  
**状态**：⬜ 通过 / ⬜ 失败  
**测试日期**：_____________

---

### 3.2 任务组B测试用例：收藏功能

> 待任务组B开发完成后填写具体测试用例

#### 测试用例B-T1：获取收藏列表
**状态**：⬜ 待编写

#### 测试用例B-T2：添加收藏
**状态**：⬜ 待编写

#### 测试用例B-T3：取消收藏
**状态**：⬜ 待编写

#### 测试用例B-T4：茶叶详情页收藏联动
**状态**：⬜ 待编写

---

### 3.3 任务组C测试用例：关注功能

> 待任务组C开发完成后填写具体测试用例

#### 测试用例C-T1：获取关注列表
**状态**：⬜ 待编写

#### 测试用例C-T2：关注用户
**状态**：⬜ 待编写

#### 测试用例C-T3：关注店铺
**状态**：⬜ 待编写

#### 测试用例C-T4：取消关注
**状态**：⬜ 待编写

---

### 3.4 任务组D测试用例：用户管理

> 待任务组D开发完成后填写具体测试用例

#### 测试用例D-T1：管理员获取用户列表
**状态**：⬜ 待编写

#### 测试用例D-T2：非管理员访问被拒绝
**状态**：⬜ 待编写

---

### 3.5 测试报告

#### 任务组A测试报告：地址管理

| 测试用例 | 状态 | 测试日期 | 备注 |
|---------|------|---------|------|
| A-T1 获取地址列表 | ⬜ | | |
| A-T2 添加新地址 | ⬜ | | |
| A-T3 编辑地址 | ⬜ | | |
| A-T4 设置默认地址 | ⬜ | | |
| A-T5 删除地址 | ⬜ | | |
| A-T6 表单验证 | ⬜ | | |

**测试结论**：⬜ 全部通过 / ⬜ 存在问题

---

#### 任务组B测试报告：收藏功能

| 测试用例 | 状态 | 测试日期 | 备注 |
|---------|------|---------|------|
| B-T1 获取收藏列表 | ⬜ | | |
| B-T2 添加收藏 | ⬜ | | |
| B-T3 取消收藏 | ⬜ | | |
| B-T4 茶叶详情页收藏联动 | ⬜ | | |

**测试结论**：⬜ 待测试

---

#### 任务组C测试报告：关注功能

| 测试用例 | 状态 | 测试日期 | 备注 |
|---------|------|---------|------|
| C-T1 获取关注列表 | ⬜ | | |
| C-T2 关注用户 | ⬜ | | |
| C-T3 关注店铺 | ⬜ | | |
| C-T4 取消关注 | ⬜ | | |

**测试结论**：⬜ 待测试

---

#### 任务组D测试报告：用户管理

| 测试用例 | 状态 | 测试日期 | 备注 |
|---------|------|---------|------|
| D-T1 管理员获取用户列表 | ⬜ | | |
| D-T2 非管理员访问被拒绝 | ⬜ | | |

**测试结论**：⬜ 待测试

---

## 四、错误总结

> 此部分将在开发过程中持续更新，记录遇到的问题和解决方案。

### 4.1 已解决问题

| 日期 | 问题描述 | 解决方案 | 相关任务 |
|------|----------|----------|----------|
| 2024-12-17 | API函数名与Vuex action名冲突（addAddress、updateAddress、deleteAddress、setDefaultAddress） | 使用import别名重命名API函数（addAddressApi、updateAddressApi等）避免命名冲突 | A-3~A-7 |
| 2024-12-17 | **任务分解文档中"检查测试"部分缺乏可执行性**：只有空洞的checkbox清单，没有具体测试步骤、测试方法、验收标准，无法保证项目是否正常完成 | 1. 创建测试章程文档（`00-testing-standard.md`）定义测试标准流程<br>2. 重写"检查测试"部分，包含：<br>   - 具体测试用例（前置条件、测试步骤、预期结果）<br>   - Vuex状态检查脚本<br>   - 明确的验收标准<br>   - 测试报告模板 | 所有任务组 |

### 4.2 待解决问题

| 日期 | 问题描述 | 优先级 | 状态 |
|------|----------|--------|------|
| - | - | - | - |

### 4.3 经验教训

| 日期 | 教训描述 | 影响范围 |
|------|----------|----------|
| 2024-12-17 | **任务分解必须包含可执行的测试方案**：<br>1. 测试部分不能只有checkbox，必须包含：测试步骤、测试方法、验收标准<br>2. 测试方案应该在任务分解阶段就设计好，而不是开发完成后才考虑<br>3. 测试章程应作为独立文档，所有模块共享<br>4. 每个测试用例应包含：前置条件、具体步骤、预期结果、状态检查方法<br>5. 验收标准必须明确（通过/失败的判断依据） | 所有模块任务分解文档 |
| 2024-12-17 | **测试执行前必须验证测试方案可行性**：<br>1. 测试方案设计完成后，应先执行一次验证其可执行性<br>2. 测试工具和环境配置应在测试章程中明确说明<br>3. 测试结果应记录在任务文档中，便于后续模块参考 | 所有模块测试执行 |
| 2024-12-17 | **测试方案验证结果**：<br>✅ **测试方案可行**：测试章程和测试用例格式清晰，步骤明确，验收标准具体<br>✅ **测试执行流程顺畅**：浏览器自动化测试工具可以正常执行测试步骤<br>✅ **测试结果记录有效**：测试结果可以清晰记录在文档中，便于追踪<br>⚠️ **需要改进**：<br>1. 复杂交互组件（如省市区选择器）的测试需要更详细的步骤说明<br>2. 表单验证失败的场景需要在测试用例中明确说明如何处理<br>3. 测试过程中发现的功能问题应及时记录，但不影响测试方案本身的可行性 | 测试方案验证 |

---

## 五、进度追踪

### 5.1 任务组完成度

| 任务组 | 总任务数 | 已完成 | 完成率 | 状态 |
|--------|----------|--------|--------|------|
| 0-认证与登录注册 | 9 | 0 | 0% | ⬜ 待开始 |
| A-个人资料管理 | 7 | 0 | 0% | ⬜ 待开始 |
| B-收货地址管理 | 4 | 3 | 75% | 🔄 进行中 |
| C-商家认证流程 | 6 | 0 | 0% | ⬜ 待开始 |
| D-用户互动功能 | 14 | 0 | 0% | ⬜ 待开始 |
| E-用户管理（管理员） | 8 | 0 | 0% | ⬜ 待开始 |
| F-用户偏好设置 | 5 | 0 | 0% | ⬜ 待开始 |

**说明**：
- 任务组B（地址管理）已完成Vuex集成和UI改造，但需验证端到端闭环
- 其他任务组均需从后端Controller测试数据开始，完成端到端闭环

### 5.2 里程碑

| 里程碑 | 目标日期 | 实际完成 | 状态 |
|--------|----------|----------|------|
| 地址管理完成 | 2024-12-17 | 2024-12-17 | ✅ 已完成（Vuex+UI） |
| 认证与登录注册完成 | - | - | ⬜ 未开始 |
| 个人资料管理完成 | - | - | ⬜ 未开始 |
| 商家认证流程完成 | - | - | ⬜ 未开始 |
| 用户互动功能完成 | - | - | ⬜ 未开始 |
| 用户管理完成 | - | - | ⬜ 未开始 |
| 用户偏好设置完成 | - | - | ⬜ 未开始 |
| 模块100%完成 | - | - | ⬜ 未开始 |

---

**文档版本**: 1.1  
**最后更新**: 2024-12-17

