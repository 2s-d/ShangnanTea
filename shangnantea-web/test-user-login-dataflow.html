<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·ç™»å½•æ•°æ®æµé€šæµ‹è¯•</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/vuex@4/dist/vuex.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }
        .test-panel {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
        }
        .test-panel h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        .form-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn:hover {
            background: #45a049;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.loading {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        .status.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        .log-panel {
            grid-column: 1 / -1;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry.api {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .log-entry.vuex {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
        }
        .log-entry.component {
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
        }
        .log-entry.error {
            background: #ffebee;
            border-left: 4px solid #f44336;
        }
        .data-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .flow-indicator {
            display: flex;
            align-items: center;
            margin: 10px 0;
            font-size: 12px;
            color: #666;
        }
        .flow-step {
            background: #e3f2fd;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 0 5px;
        }
        .flow-arrow {
            color: #4CAF50;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>ğŸ”„ ç”¨æˆ·ç™»å½•æ•°æ®æµé€šæµ‹è¯•</h1>
                <p>æ¨¡æ‹Ÿ Vueç»„ä»¶ â†’ Vuex â†’ API â†’ åç«¯Controller çš„å®Œæ•´æ•°æ®æµ</p>
            </div>
            
            <div class="content">
                <!-- ç™»å½•æµ‹è¯•é¢æ¿ -->
                <div class="test-panel">
                    <h3>ğŸ” ç”¨æˆ·ç™»å½•æµ‹è¯•</h3>
                    
                    <div class="form-group">
                        <label>ç”¨æˆ·å:</label>
                        <input v-model="loginForm.username" type="text" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                    </div>
                    
                    <div class="form-group">
                        <label>å¯†ç :</label>
                        <input v-model="loginForm.password" type="password" placeholder="è¯·è¾“å…¥å¯†ç ">
                    </div>
                    
                    <button class="btn" @click="testLogin" :disabled="loading">
                        {{ loading ? 'ç™»å½•ä¸­...' : 'æµ‹è¯•ç™»å½•' }}
                    </button>
                    
                    <button class="btn" @click="testLogout" :disabled="!isLoggedIn">
                        é€€å‡ºç™»å½•
                    </button>
                    
                    <button class="btn" @click="clearLogs">
                        æ¸…ç©ºæ—¥å¿—
                    </button>
                    
                    <!-- æ•°æ®æµæŒ‡ç¤ºå™¨ -->
                    <div class="flow-indicator">
                        <div class="flow-step">Vueç»„ä»¶</div>
                        <div class="flow-arrow">â†’</div>
                        <div class="flow-step">Vuex Action</div>
                        <div class="flow-arrow">â†’</div>
                        <div class="flow-step">APIè°ƒç”¨</div>
                        <div class="flow-arrow">â†’</div>
                        <div class="flow-step">åç«¯Controller</div>
                    </div>
                    
                    <!-- çŠ¶æ€æ˜¾ç¤º -->
                    <div v-if="status" :class="['status', status.type]">
                        {{ status.message }}
                    </div>
                    
                    <!-- ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º -->
                    <div v-if="userInfo" class="data-display">
                        <strong>å½“å‰ç”¨æˆ·ä¿¡æ¯:</strong>
                        {{ JSON.stringify(userInfo, null, 2) }}
                    </div>
                </div>
                
                <!-- VuexçŠ¶æ€é¢æ¿ -->
                <div class="test-panel">
                    <h3>ğŸ“Š VuexçŠ¶æ€ç›‘æ§</h3>
                    
                    <div class="form-group">
                        <label>ç™»å½•çŠ¶æ€:</label>
                        <span :style="{color: isLoggedIn ? '#4CAF50' : '#f44336'}">
                            {{ isLoggedIn ? 'å·²ç™»å½•' : 'æœªç™»å½•' }}
                        </span>
                    </div>
                    
                    <div class="form-group">
                        <label>åŠ è½½çŠ¶æ€:</label>
                        <span :style="{color: loading ? '#ff9800' : '#4CAF50'}">
                            {{ loading ? 'åŠ è½½ä¸­' : 'ç©ºé—²' }}
                        </span>
                    </div>
                    
                    <div class="form-group">
                        <label>ç”¨æˆ·è§’è‰²:</label>
                        <span>{{ userRole }}</span>
                    </div>
                    
                    <div class="data-display">
                        <strong>å®Œæ•´Vuex State:</strong>
                        {{ JSON.stringify(vuexState, null, 2) }}
                    </div>
                </div>
                
                <!-- æ—¥å¿—é¢æ¿ -->
                <div class="log-panel">
                    <h3>ğŸ“ æ•°æ®æµé€šæ—¥å¿—</h3>
                    <div v-for="(log, index) in logs" :key="index" :class="['log-entry', log.type]">
                        <strong>[{{ log.timestamp }}] {{ log.source }}:</strong> {{ log.message }}
                        <div v-if="log.data" class="data-display" style="margin-top: 5px;">
                            {{ typeof log.data === 'string' ? log.data : JSON.stringify(log.data, null, 2) }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        const { createStore } = Vuex;

        // æ¨¡æ‹Ÿåç«¯APIå“åº”
        const mockBackendAPI = {
            // æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•API
            login: async (loginData) => {
                // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // æ¨¡æ‹Ÿç™»å½•éªŒè¯
                if (loginData.username === 'admin' && loginData.password === '123456') {
                    return {
                        success: true,
                        data: {
                            token: 'mock_jwt_token_' + Date.now(),
                            userInfo: {
                                id: 1,
                                username: 'admin',
                                nickname: 'ç®¡ç†å‘˜',
                                email: 'admin@shangnantea.com',
                                phone: '13800138000',
                                avatar: 'https://via.placeholder.com/60x60/4CAF50/FFFFFF?text=Admin',
                                role: 1,
                                status: 1,
                                createTime: new Date().toISOString(),
                                lastLoginTime: new Date().toISOString()
                            }
                        }
                    };
                } else if (loginData.username === 'user' && loginData.password === '123456') {
                    return {
                        success: true,
                        data: {
                            token: 'mock_jwt_token_' + Date.now(),
                            userInfo: {
                                id: 2,
                                username: 'user',
                                nickname: 'æ™®é€šç”¨æˆ·',
                                email: 'user@shangnantea.com',
                                phone: '13800138001',
                                avatar: 'https://via.placeholder.com/60x60/2196F3/FFFFFF?text=User',
                                role: 2,
                                status: 1,
                                createTime: new Date().toISOString(),
                                lastLoginTime: new Date().toISOString()
                            }
                        }
                    };
                } else {
                    throw new Error('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
                }
            },
            
            // æ¨¡æ‹Ÿé€€å‡ºç™»å½•API
            logout: async () => {
                await new Promise(resolve => setTimeout(resolve, 500));
                return { success: true, message: 'é€€å‡ºæˆåŠŸ' };
            }
        };

        // åˆ›å»ºVuex Store
        const store = createStore({
            modules: {
                user: {
                    namespaced: true,
                    state: {
                        userInfo: null,
                        isLoggedIn: false,
                        loading: false,
                        token: null
                    },
                    getters: {
                        userRole: state => {
                            if (!state.userInfo) return 'æœªç™»å½•';
                            switch (state.userInfo.role) {
                                case 1: return 'ç®¡ç†å‘˜';
                                case 2: return 'æ™®é€šç”¨æˆ·';
                                case 3: return 'å•†å®¶';
                                default: return 'æœªçŸ¥è§’è‰²';
                            }
                        }
                    },
                    mutations: {
                        SET_USER_INFO(state, userInfo) {
                            state.userInfo = userInfo;
                        },
                        SET_LOGGED_IN(state, status) {
                            state.isLoggedIn = status;
                        },
                        SET_LOADING(state, status) {
                            state.loading = status;
                        },
                        SET_TOKEN(state, token) {
                            state.token = token;
                        },
                        CLEAR_USER(state) {
                            state.userInfo = null;
                            state.isLoggedIn = false;
                            state.token = null;
                        }
                    },
                    actions: {
                        async login({ commit }, loginData) {
                            try {
                                commit('SET_LOADING', true);
                                
                                // è°ƒç”¨API
                                const response = await mockBackendAPI.login(loginData);
                                const { token, userInfo } = response.data;
                                
                                // æ›´æ–°çŠ¶æ€
                                commit('SET_TOKEN', token);
                                commit('SET_USER_INFO', userInfo);
                                commit('SET_LOGGED_IN', true);
                                
                                return userInfo;
                            } finally {
                                commit('SET_LOADING', false);
                            }
                        },
                        
                        async logout({ commit }) {
                            try {
                                commit('SET_LOADING', true);
                                
                                // è°ƒç”¨API
                                await mockBackendAPI.logout();
                                
                                // æ¸…é™¤çŠ¶æ€
                                commit('CLEAR_USER');
                                
                                return true;
                            } finally {
                                commit('SET_LOADING', false);
                            }
                        }
                    }
                }
            }
        });

        // åˆ›å»ºVueåº”ç”¨
        const app = createApp({
            data() {
                return {
                    loginForm: {
                        username: 'admin',
                        password: '123456'
                    },
                    status: null,
                    logs: []
                };
            },
            computed: {
                userInfo() {
                    return this.$store.state.user.userInfo;
                },
                isLoggedIn() {
                    return this.$store.state.user.isLoggedIn;
                },
                loading() {
                    return this.$store.state.user.loading;
                },
                userRole() {
                    return this.$store.getters['user/userRole'];
                },
                vuexState() {
                    return this.$store.state.user;
                }
            },
            methods: {
                addLog(source, message, data = null, type = 'component') {
                    const timestamp = new Date().toLocaleTimeString();
                    this.logs.push({
                        timestamp,
                        source,
                        message,
                        data,
                        type
                    });
                    
                    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                    this.$nextTick(() => {
                        const logPanel = document.querySelector('.log-panel');
                        logPanel.scrollTop = logPanel.scrollHeight;
                    });
                },
                
                async testLogin() {
                    this.status = null;
                    this.addLog('Vueç»„ä»¶', 'å¼€å§‹ç™»å½•æµç¨‹', this.loginForm);
                    
                    try {
                        this.addLog('Vueç»„ä»¶', 'è°ƒç”¨Vuex Action: user/login', null, 'vuex');
                        
                        // ç›‘å¬VuexçŠ¶æ€å˜åŒ–
                        const unwatch = this.$store.watch(
                            (state) => state.user.loading,
                            (newVal) => {
                                if (newVal) {
                                    this.addLog('Vuex', 'SET_LOADING: true', null, 'vuex');
                                    this.addLog('API', 'å‘é€POSTè¯·æ±‚åˆ° /api/user/login', this.loginForm, 'api');
                                }
                            }
                        );
                        
                        // æ‰§è¡Œç™»å½•
                        const userInfo = await this.$store.dispatch('user/login', this.loginForm);
                        
                        unwatch();
                        
                        this.addLog('API', 'åç«¯Controllerå“åº”æˆåŠŸ', {
                            token: 'mock_jwt_token_***',
                            userInfo: userInfo
                        }, 'api');
                        
                        this.addLog('Vuex', 'SET_USER_INFO + SET_LOGGED_IN', userInfo, 'vuex');
                        this.addLog('Vueç»„ä»¶', 'ç™»å½•æˆåŠŸï¼ŒUIçŠ¶æ€æ›´æ–°');
                        
                        this.status = {
                            type: 'success',
                            message: 'ç™»å½•æˆåŠŸï¼æ•°æ®æµé€šæµ‹è¯•å®Œæˆã€‚'
                        };
                        
                    } catch (error) {
                        this.addLog('API', 'åç«¯Controllerå“åº”å¤±è´¥', error.message, 'error');
                        this.addLog('Vueç»„ä»¶', 'ç™»å½•å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯', null, 'error');
                        
                        this.status = {
                            type: 'error',
                            message: 'ç™»å½•å¤±è´¥: ' + error.message
                        };
                    }
                },
                
                async testLogout() {
                    this.status = null;
                    this.addLog('Vueç»„ä»¶', 'å¼€å§‹é€€å‡ºç™»å½•æµç¨‹');
                    
                    try {
                        this.addLog('Vueç»„ä»¶', 'è°ƒç”¨Vuex Action: user/logout', null, 'vuex');
                        this.addLog('API', 'å‘é€POSTè¯·æ±‚åˆ° /api/user/logout', null, 'api');
                        
                        await this.$store.dispatch('user/logout');
                        
                        this.addLog('API', 'åç«¯Controllerå“åº”æˆåŠŸ', { message: 'é€€å‡ºæˆåŠŸ' }, 'api');
                        this.addLog('Vuex', 'CLEAR_USER: æ¸…é™¤ç”¨æˆ·çŠ¶æ€', null, 'vuex');
                        this.addLog('Vueç»„ä»¶', 'é€€å‡ºæˆåŠŸï¼ŒUIçŠ¶æ€æ›´æ–°');
                        
                        this.status = {
                            type: 'success',
                            message: 'é€€å‡ºç™»å½•æˆåŠŸï¼'
                        };
                        
                    } catch (error) {
                        this.addLog('API', 'é€€å‡ºç™»å½•å¤±è´¥', error.message, 'error');
                        
                        this.status = {
                            type: 'error',
                            message: 'é€€å‡ºç™»å½•å¤±è´¥: ' + error.message
                        };
                    }
                },
                
                clearLogs() {
                    this.logs = [];
                    this.status = null;
                }
            },
            
            mounted() {
                this.addLog('ç³»ç»Ÿ', 'æ•°æ®æµé€šæµ‹è¯•é¡µé¢åˆå§‹åŒ–å®Œæˆ');
                this.addLog('ç³»ç»Ÿ', 'æµ‹è¯•è´¦å·: admin/123456 (ç®¡ç†å‘˜) æˆ– user/123456 (æ™®é€šç”¨æˆ·)');
            }
        });

        app.use(store);
        app.mount('#app');
    </script>
</body>
</html>