# API 测试架构

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                     开发服务器 (localhost:8083)                │
│                                                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  Vue 页面    │  │  API 接口    │  │  Mock 数据   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                            ↑
                            │ HTTP 请求
                            │
┌─────────────────────────────────────────────────────────────┐
│                    Playwright 测试框架                         │
│                                                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              API 测试 (api-tests/)                     │   │
│  │                                                        │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐           │   │
│  │  │ 用户模块  │  │ 茶叶模块  │  │ 订单模块  │  ...      │   │
│  │  └──────────┘  └──────────┘  └──────────┘           │   │
│  │       │              │              │                 │   │
│  │       ├─ login.spec.js                               │   │
│  │       ├─ register.spec.js                            │   │
│  │       └─ ...                                          │   │
│  └──────────────────────────────────────────────────────┘   │
│                            ↓                                  │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              辅助工具 (helpers/)                       │   │
│  │                                                        │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌────────────┐ │   │
│  │  │ api-helper   │  │ auth-helper  │  │ error-     │ │   │
│  │  │              │  │              │  │ collector  │ │   │
│  │  │ • 监控 API   │  │ • 模拟登录   │  │ • 收集错误 │ │   │
│  │  │ • 等待响应   │  │ • Token 管理 │  │ • 错误去重 │ │   │
│  │  └──────────────┘  └──────────────┘  └────────────┘ │   │
│  └──────────────────────────────────────────────────────┘   │
│                            ↓                                  │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              测试数据 (fixtures/)                      │   │
│  │                                                        │   │
│  │  test-data.json                                       │   │
│  │  • 用户数据                                            │   │
│  │  • 茶叶数据                                            │   │
│  │  • 地址数据                                            │   │
│  │  • 订单数据                                            │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      测试报告                                 │
│                                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 控制台输出    │  │ JSON 报告     │  │ 错误截图      │      │
│  │              │  │              │  │              │      │
│  │ • 实时结果   │  │ • 详细数据   │  │ • 错误现场   │      │
│  │ • 错误信息   │  │ • 统计信息   │  │ • 页面状态   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

## 🔄 测试执行流程

```
1. 启动测试
   │
   ├─ run-api-test.bat
   │   └─ run-e2e.ps1
   │       └─ npx playwright test
   │
2. 初始化测试
   │
   ├─ 创建错误收集器
   ├─ 加载测试数据
   └─ 设置错误监听器
   │
3. 执行测试用例
   │
   ├─ 前置条件（如需要）
   │   └─ mockLogin(page, 'user')
   │
   ├─ 访问页面
   │   └─ page.goto('/path')
   │
   ├─ 监控 API
   │   └─ page.waitForResponse(...)
   │
   ├─ 触发操作
   │   ├─ 填写表单
   │   ├─ 点击按钮
   │   └─ 等待响应
   │
   ├─ 验证结果
   │   ├─ HTTP 状态码 = 200
   │   ├─ 业务状态码 = 期望值
   │   └─ 无控制台错误
   │
4. 收集结果
   │
   ├─ 错误去重
   ├─ 生成统计
   └─ 保存报告
   │
5. 输出报告
   │
   ├─ 控制台输出
   ├─ JSON 文件
   └─ 错误截图（如有）
```

## 📦 模块依赖关系

```
api-tests/user/login.spec.js
    │
    ├─ require('@playwright/test')
    │   └─ Playwright 测试框架
    │
    ├─ require('../../helpers/error-collector')
    │   ├─ setupErrorListeners()
    │   └─ createErrorCollector()
    │
    ├─ require('../../helpers/auth-helper')
    │   ├─ mockLogin()
    │   ├─ clearAuth()
    │   └─ getToken()
    │
    ├─ require('../../helpers/api-helper')
    │   ├─ monitorApiCall()
    │   └─ waitForApi()
    │
    └─ require('../../fixtures/test-data.json')
        └─ 测试数据
```

## 🎯 测试策略层次

```
┌─────────────────────────────────────────────────────────┐
│ 层次 1: API 端点测试 (166 个)                             │
│                                                           │
│ 每个 API 一个测试文件                                      │
│ 验证: API 成功 + 无控制台错误                              │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│ 层次 2: 业务流程测试 (可选)                               │
│                                                           │
│ 多个 API 组合测试                                         │
│ 验证: 完整业务流程                                        │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│ 层次 3: UI 交互测试 (可选)                                │
│                                                           │
│ 复杂的用户交互场景                                        │
│ 验证: UI 响应正确                                         │
└─────────────────────────────────────────────────────────┘
```

**当前实施**: 专注于层次 1（API 端点测试）

## 🔧 错误收集机制

```
┌─────────────────────────────────────────────────────────┐
│                    页面错误源                              │
│                                                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ Console Error│  │ Runtime Error│  │ Network Error│  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│                 错误监听器 (setupErrorListeners)          │
│                                                           │
│  page.on('console', ...)                                 │
│  page.on('pageerror', ...)                               │
│  page.on('response', ...)                                │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│                 错误过滤 (shouldIgnoreError)              │
│                                                           │
│  • Vue Devtools 警告                                      │
│  • Element Plus 废弃警告                                  │
│  • ResizeObserver 警告                                    │
│  • Hot Update 请求                                        │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│                 错误去重 (deduplicateErrors)              │
│                                                           │
│  基于错误消息的前 100 个字符去重                           │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│                 错误收集器 (errorCollector)               │
│                                                           │
│  • 按测试分组                                             │
│  • 统计信息                                               │
│  • 生成报告                                               │
└─────────────────────────────────────────────────────────┘
```

## 🚀 测试复用机制

```
测试 A: 用户登录
    └─ 返回: token

测试 B: 获取用户信息
    ├─ 前置: mockLogin(page, 'user')  ← 复用登录逻辑
    └─ 测试: GET /user/me

测试 C: 更新用户信息
    ├─ 前置: mockLogin(page, 'user')  ← 复用登录逻辑
    └─ 测试: PUT /user

测试 D: 创建订单
    ├─ 前置: mockLogin(page, 'user')  ← 复用登录逻辑
    └─ 测试: POST /order
```

**优势**: 
- 不需要重复测试登录流程
- 测试速度更快
- 维护成本更低

## 📊 数据流向

```
test-data.json
    │
    ├─ users.user.username ──────┐
    ├─ users.user.password ──────┤
    │                            │
    └─ address.sample.* ─────────┤
                                 │
                                 ↓
                        测试用例 (*.spec.js)
                                 │
                                 ↓
                        填写表单 / 触发 API
                                 │
                                 ↓
                        API 请求 → 服务器
                                 │
                                 ↓
                        API 响应 ← 服务器
                                 │
                                 ↓
                        验证响应 + 收集错误
                                 │
                                 ↓
                        生成报告
                                 │
                                 ├─ 控制台输出
                                 ├─ JSON 文件
                                 └─ 错误截图
```

## 🎨 测试模式

### 模式 1: 自动加载型 API

```
访问页面 → API 自动调用 → 验证响应
```

示例: 列表页、详情页

### 模式 2: 按钮触发型 API

```
访问页面 → 点击按钮 → API 调用 → 验证响应
```

示例: 删除、提交、保存

### 模式 3: 表单提交型 API

```
访问页面 → 填写表单 → 提交表单 → API 调用 → 验证响应
```

示例: 登录、注册、编辑

## 🔐 认证流程

```
mockLogin(page, 'user')
    │
    ├─ 访问 /login 页面
    │
    ├─ 设置 localStorage
    │   └─ shangnantea_token = JWT Token
    │
    └─ Token Payload:
        ├─ sub: 用户ID
        ├─ role: 角色 (1=admin, 2=user, 3=shop)
        ├─ username: 用户名
        ├─ exp: 过期时间 (2030-01-01)
        └─ iss: 签发者
```

## 📈 扩展性设计

### 添加新模块

```
1. 创建目录: api-tests/<新模块>/
2. 创建测试: <新模块>/<功能>.spec.js
3. 复用工具: helpers/ 中的辅助函数
4. 更新文档: API-TEST-IMPLEMENTATION-STATUS.md
```

### 添加新辅助函数

```
1. 创建文件: helpers/<功能>-helper.js
2. 导出函数: module.exports = { ... }
3. 在测试中引用: require('../../helpers/<功能>-helper')
```

### 添加新测试数据

```
1. 编辑文件: fixtures/test-data.json
2. 添加数据: { "新模块": { ... } }
3. 在测试中使用: testData.新模块.*
```

## 🎯 设计原则

1. **单一职责**: 每个测试只测试一个 API
2. **可复用性**: 辅助函数可在所有测试中复用
3. **可维护性**: 清晰的目录结构和命名规范
4. **可扩展性**: 易于添加新模块和新测试
5. **独立性**: 测试之间相互独立，可并行执行

---

**架构设计**: 模块化、可扩展、易维护
