# è®¢å•æ¨¡å—ä¸šåŠ¡é€»è¾‘ç¼ºå¤±æ£€æŸ¥æŠ¥å‘Š

## æ£€æŸ¥æ—¶é—´
2026-01-25

## æ£€æŸ¥èŒƒå›´
è®¢å•æ¨¡å—çš„21ä¸ªæ¥å£ï¼Œé‡ç‚¹æ£€æŸ¥ï¼š
1. åº“å­˜ç®¡ç†é€»è¾‘
2. é”€é‡ç»Ÿè®¡é€»è¾‘
3. è´­ç‰©è½¦å…³è”é€»è¾‘
4. è¯„ä»·åŠŸèƒ½å®Œæ•´æ€§
5. å…¶ä»–ä¸šåŠ¡é€»è¾‘å®Œæ•´æ€§

---

## ğŸ”´ ä¸¥é‡é—®é¢˜ï¼šåº“å­˜ç®¡ç†å®Œå…¨ç¼ºå¤±

### é—®é¢˜æè¿°
æ•´ä¸ªè®¢å•æµç¨‹**å®Œå…¨æ²¡æœ‰åº“å­˜ç®¡ç†**ï¼Œè¿™æ˜¯æœ€ä¸¥é‡çš„ä¸šåŠ¡é€»è¾‘ç¼ºå¤±ï¼

### å…·ä½“é—®é¢˜

#### 1. åˆ›å»ºè®¢å•ï¼ˆcreateOrderï¼‰
- âœ… **å·²å®ç°**ï¼šæ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³
- âŒ **ç¼ºå¤±**ï¼šæ²¡æœ‰æ‰£å‡åº“å­˜
- **å½±å“**ï¼šç”¨æˆ·å¯ä»¥æ— é™ä¸‹å•ï¼Œåº“å­˜å½¢åŒè™šè®¾

#### 2. æ”¯ä»˜è®¢å•ï¼ˆpayOrderï¼‰
- âŒ **ç¼ºå¤±**ï¼šæ²¡æœ‰æ‰£å‡åº“å­˜
- âŒ **ç¼ºå¤±**ï¼šæ²¡æœ‰å¢åŠ é”€é‡
- **å½±å“**ï¼š
  - æ”¯ä»˜æˆåŠŸååº“å­˜ä¸å‡å°‘ï¼Œå¯¼è‡´è¶…å–
  - é”€é‡æ•°æ®å®Œå…¨ä¸å‡†ç¡®
  - å•†å®¶æ— æ³•æ­£ç¡®ç®¡ç†åº“å­˜

#### 3. å–æ¶ˆè®¢å•ï¼ˆcancelOrderï¼‰
- âŒ **ç¼ºå¤±**ï¼šå¦‚æœè®¢å•å·²æ”¯ä»˜ï¼ˆå¾…å‘è´§çŠ¶æ€ï¼‰ï¼Œå–æ¶ˆæ—¶æ²¡æœ‰æ¢å¤åº“å­˜
- **å½±å“**ï¼šå·²æ‰£å‡çš„åº“å­˜æ— æ³•æ¢å¤ï¼Œå¯¼è‡´åº“å­˜æ•°æ®é”™è¯¯

#### 4. é€€æ¬¾æˆåŠŸï¼ˆprocessRefundï¼‰
- âŒ **ç¼ºå¤±**ï¼šåŒæ„é€€æ¬¾æ—¶æ²¡æœ‰æ¢å¤åº“å­˜
- âŒ **ç¼ºå¤±**ï¼šæ²¡æœ‰å‡å°‘é”€é‡
- **å½±å“**ï¼š
  - é€€æ¬¾ååº“å­˜ä¸æ¢å¤
  - é”€é‡æ•°æ®ä¸å‡†ç¡®

### æŠ€æœ¯ç»†èŠ‚

#### æ•°æ®åº“å·²æœ‰ç›¸å…³SQL
åœ¨ `TeaMapper.xml` å’Œ `TeaSpecificationMapper.xml` ä¸­å·²ç»å®šä¹‰äº†æ›´æ–°åº“å­˜å’Œé”€é‡çš„SQLï¼š

```xml
<!-- TeaMapper.xml -->
<update id="updateStockAndSales">
    UPDATE teas
    SET stock = stock - #{quantity,jdbcType=INTEGER},
    sales = sales + #{quantity,jdbcType=INTEGER},
    update_time = now()
    WHERE id = #{id,jdbcType=VARCHAR} AND stock >= #{quantity,jdbcType=INTEGER}
</update>

<!-- TeaSpecificationMapper.xml -->
<update id="updateStock">
    UPDATE tea_specifications
    SET stock = stock - #{quantity,jdbcType=INTEGER},
    update_time = now()
    WHERE id = #{id,jdbcType=INTEGER} AND stock >= #{quantity,jdbcType=INTEGER}
</update>
```

#### ä½† Mapper æ¥å£æœªå£°æ˜æ–¹æ³•
`TeaMapper.java` å’Œ `TeaSpecificationMapper.java` ä¸­**æ²¡æœ‰å£°æ˜**è¿™äº›æ–¹æ³•ï¼Œå¯¼è‡´æ— æ³•è°ƒç”¨ï¼

### ä¿®å¤å»ºè®®

#### 1. åœ¨ Mapper æ¥å£ä¸­å£°æ˜æ–¹æ³•

**TeaMapper.java**ï¼š
```java
/**
 * æ›´æ–°åº“å­˜å’Œé”€é‡
 * @param id èŒ¶å¶ID
 * @param quantity æ•°é‡
 * @return å½±å“è¡Œæ•°
 */
int updateStockAndSales(@Param("id") String id, @Param("quantity") Integer quantity);

/**
 * æ¢å¤åº“å­˜å’Œé”€é‡ï¼ˆç”¨äºå–æ¶ˆè®¢å•/é€€æ¬¾ï¼‰
 * @param id èŒ¶å¶ID
 * @param quantity æ•°é‡
 * @return å½±å“è¡Œæ•°
 */
int restoreStockAndSales(@Param("id") String id, @Param("quantity") Integer quantity);
```

**TeaSpecificationMapper.java**ï¼š
```java
/**
 * æ›´æ–°è§„æ ¼åº“å­˜
 * @param id è§„æ ¼ID
 * @param quantity æ•°é‡
 * @return å½±å“è¡Œæ•°
 */
int updateStock(@Param("id") Integer id, @Param("quantity") Integer quantity);

/**
 * æ¢å¤è§„æ ¼åº“å­˜ï¼ˆç”¨äºå–æ¶ˆè®¢å•/é€€æ¬¾ï¼‰
 * @param id è§„æ ¼ID
 * @param quantity æ•°é‡
 * @return å½±å“è¡Œæ•°
 */
int restoreStock(@Param("id") Integer id, @Param("quantity") Integer quantity);
```

#### 2. åœ¨ XML ä¸­æ·»åŠ æ¢å¤åº“å­˜çš„SQL

**TeaMapper.xml**ï¼š
```xml
<!-- æ¢å¤åº“å­˜å’Œé”€é‡ -->
<update id="restoreStockAndSales">
    UPDATE teas
    SET stock = stock + #{quantity,jdbcType=INTEGER},
    sales = sales - #{quantity,jdbcType=INTEGER},
    update_time = now()
    WHERE id = #{id,jdbcType=VARCHAR}
</update>
```

**TeaSpecificationMapper.xml**ï¼š
```xml
<!-- æ¢å¤åº“å­˜ -->
<update id="restoreStock">
    UPDATE tea_specifications
    SET stock = stock + #{quantity,jdbcType=INTEGER},
    update_time = now()
    WHERE id = #{id,jdbcType=INTEGER}
</update>
```

#### 3. ä¿®æ”¹è®¢å•æœåŠ¡å®ç°

**æ”¯ä»˜è®¢å•æ—¶ï¼ˆpayOrderï¼‰**ï¼š
```java
// 7. æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå¾…å‘è´§
order.setStatus(Order.STATUS_PENDING_SHIPMENT);
order.setPaymentMethod(paymentMethod);
order.setPaymentTime(new Date());
order.setUpdateTime(new Date());

// ã€æ–°å¢ã€‘æ‰£å‡åº“å­˜å’Œå¢åŠ é”€é‡
if (order.getSpecId() != null) {
    // æœ‰è§„æ ¼ï¼Œæ›´æ–°è§„æ ¼åº“å­˜
    int rows = teaSpecificationMapper.updateStock(order.getSpecId(), order.getQuantity());
    if (rows == 0) {
        logger.warn("æ”¯ä»˜è®¢å•å¤±è´¥: åº“å­˜ä¸è¶³æˆ–è§„æ ¼ä¸å­˜åœ¨: specId={}, quantity={}", 
                   order.getSpecId(), order.getQuantity());
        return Result.failure(5111); // å•†å“åº“å­˜ä¸è¶³
    }
} else {
    // æ— è§„æ ¼ï¼Œæ›´æ–°èŒ¶å¶åº“å­˜å’Œé”€é‡
    int rows = teaMapper.updateStockAndSales(order.getTeaId(), order.getQuantity());
    if (rows == 0) {
        logger.warn("æ”¯ä»˜è®¢å•å¤±è´¥: åº“å­˜ä¸è¶³æˆ–å•†å“ä¸å­˜åœ¨: teaId={}, quantity={}", 
                   order.getTeaId(), order.getQuantity());
        return Result.failure(5111); // å•†å“åº“å­˜ä¸è¶³
    }
}

int rows = orderMapper.updateById(order);
// ... åç»­ä»£ç 
```

**å–æ¶ˆè®¢å•æ—¶ï¼ˆcancelOrderï¼‰**ï¼š
```java
// 6. æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²å–æ¶ˆ
order.setStatus(Order.STATUS_CANCELLED);
order.setCancelReason(cancelReason);
order.setCancelTime(new Date());
order.setUpdateTime(new Date());

// ã€æ–°å¢ã€‘å¦‚æœè®¢å•å·²æ”¯ä»˜ï¼ˆå¾…å‘è´§çŠ¶æ€ï¼‰ï¼Œéœ€è¦æ¢å¤åº“å­˜
if (order.getStatus() == Order.STATUS_PENDING_SHIPMENT) {
    if (order.getSpecId() != null) {
        // æœ‰è§„æ ¼ï¼Œæ¢å¤è§„æ ¼åº“å­˜
        teaSpecificationMapper.restoreStock(order.getSpecId(), order.getQuantity());
    } else {
        // æ— è§„æ ¼ï¼Œæ¢å¤èŒ¶å¶åº“å­˜å’Œé”€é‡
        teaMapper.restoreStockAndSales(order.getTeaId(), order.getQuantity());
    }
    logger.info("å·²æ¢å¤åº“å­˜: orderId={}, teaId={}, specId={}, quantity={}", 
               orderId, order.getTeaId(), order.getSpecId(), order.getQuantity());
}

int rows = orderMapper.updateById(order);
// ... åç»­ä»£ç 
```

**é€€æ¬¾æˆåŠŸæ—¶ï¼ˆprocessRefundï¼‰**ï¼š
```java
// åŒæ„é€€æ¬¾
order.setRefundStatus(2); // 2:å·²åŒæ„
order.setStatus(Order.STATUS_REFUNDED); // è®¢å•çŠ¶æ€æ”¹ä¸ºå·²é€€æ¬¾
order.setRefundProcessTime(new Date());
order.setUpdateTime(new Date());

// ã€æ–°å¢ã€‘æ¢å¤åº“å­˜å’Œé”€é‡
if (order.getSpecId() != null) {
    // æœ‰è§„æ ¼ï¼Œæ¢å¤è§„æ ¼åº“å­˜
    teaSpecificationMapper.restoreStock(order.getSpecId(), order.getQuantity());
} else {
    // æ— è§„æ ¼ï¼Œæ¢å¤èŒ¶å¶åº“å­˜å’Œé”€é‡
    teaMapper.restoreStockAndSales(order.getTeaId(), order.getQuantity());
}
logger.info("é€€æ¬¾æˆåŠŸï¼Œå·²æ¢å¤åº“å­˜: orderId={}, teaId={}, specId={}, quantity={}", 
           id, order.getTeaId(), order.getSpecId(), order.getQuantity());

int rows = orderMapper.updateById(order);
// ... åç»­ä»£ç 
```

---

## âœ… æ­£ç¡®å®ç°çš„åŠŸèƒ½

### 1. è¯„ä»·åŠŸèƒ½ï¼ˆreviewOrderï¼‰
- âœ… **å·²æ­£ç¡®å®ç°**ï¼šå°†è¯„ä»·æ’å…¥åˆ° `tea_review` è¡¨
- âœ… åŒæ—¶æ›´æ–°è®¢å•çš„ `buyerRate` å­—æ®µ
- âœ… æ”¯æŒè¯„ä»·å›¾ç‰‡ã€è¯„åˆ†ã€åŒ¿åç­‰å®Œæ•´åŠŸèƒ½
- âœ… ä½¿ç”¨ `TeaReviewMapper` æ’å…¥è¯„ä»·è®°å½•

**ä»£ç ç‰‡æ®µ**ï¼š
```java
// 7. åˆ›å»ºèŒ¶å¶è¯„ä»·è®°å½•
TeaReview review = new TeaReview();
review.setTeaId(order.getTeaId());
review.setUserId(userId);
review.setOrderId(orderId);
review.setContent(content);
review.setRating(rating);
review.setIsAnonymous(isAnonymous);
review.setLikeCount(0);

// å¤„ç†è¯„ä»·å›¾ç‰‡
if (images != null && !images.isEmpty()) {
    String imagesJson = com.alibaba.fastjson2.JSON.toJSONString(images);
    review.setImages(imagesJson);
}

review.setCreateTime(new Date());
review.setUpdateTime(new Date());

// æ’å…¥è¯„ä»·è®°å½•åˆ°tea_reviewè¡¨
teaReviewMapper.insert(review);

// 8. æ›´æ–°è®¢å•è¯„ä»·çŠ¶æ€
order.setBuyerRate(1); // å·²è¯„ä»·
order.setUpdateTime(new Date());
orderMapper.updateById(order);
```

---

## âš ï¸ å…¶ä»–æ½œåœ¨é—®é¢˜

### 1. è´­ç‰©è½¦æ¸…ç©ºé—®é¢˜
**é—®é¢˜**ï¼šåˆ›å»ºè®¢å•åæ²¡æœ‰æ¸…ç©ºè´­ç‰©è½¦

**åˆ†æ**ï¼š
- ä»è´­ç‰©è½¦åˆ›å»ºè®¢å•åï¼Œç†è®ºä¸Šåº”è¯¥æ¸…ç©ºå·²ä¸‹å•çš„å•†å“
- ä½†ç›®å‰çš„ `createOrder` æ¥å£æ¥æ”¶çš„æ˜¯å•†å“åˆ—è¡¨ï¼Œä¸æ˜¯è´­ç‰©è½¦IDåˆ—è¡¨
- æ— æ³•åˆ¤æ–­å“ªäº›è´­ç‰©è½¦é¡¹éœ€è¦æ¸…ç©º

**å»ºè®®**ï¼š
- å¦‚æœå‰ç«¯ä»è´­ç‰©è½¦åˆ›å»ºè®¢å•ï¼Œåº”è¯¥åœ¨å‰ç«¯è°ƒç”¨ `clearCart` æ¥å£
- æˆ–è€…ä¿®æ”¹ `createOrder` æ¥å£ï¼Œæ¥æ”¶è´­ç‰©è½¦IDåˆ—è¡¨ï¼Œåˆ›å»ºè®¢å•åè‡ªåŠ¨æ¸…ç©º

### 2. é€šçŸ¥åŠŸèƒ½ç¼ºå¤±
**é—®é¢˜**ï¼šè®¢å•çŠ¶æ€å˜æ›´æ—¶æ²¡æœ‰å‘é€é€šçŸ¥

**å½±å“**ï¼š
- æ”¯ä»˜æˆåŠŸåï¼Œå•†å®¶ä¸çŸ¥é“æœ‰æ–°è®¢å•
- å‘è´§åï¼Œä¹°å®¶ä¸çŸ¥é“è®¢å•å·²å‘è´§
- é€€æ¬¾å¤„ç†åï¼Œä¹°å®¶ä¸çŸ¥é“é€€æ¬¾ç»“æœ

**å»ºè®®**ï¼š
- åœ¨å…³é”®çŠ¶æ€å˜æ›´æ—¶ï¼Œæ’å…¥ `user_notification` è¡¨
- æˆ–è€…é›†æˆç¬¬ä¸‰æ–¹æ¶ˆæ¯æ¨é€æœåŠ¡

### 3. ç¬¬ä¸‰æ–¹æ”¯ä»˜é›†æˆ
**é—®é¢˜**ï¼šæ”¯ä»˜æ¥å£åªæ˜¯ç®€å•åœ°æ›´æ–°è®¢å•çŠ¶æ€ï¼Œæ²¡æœ‰çœŸæ­£è°ƒç”¨æ”¯ä»˜æ¥å£

**å½“å‰å®ç°**ï¼š
```java
// 6. å¦‚æœæ”¯ä»˜æ–¹å¼æ˜¯ä½™é¢ï¼ŒéªŒè¯ä½™é¢æ˜¯å¦å……è¶³ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…éœ€è¦æŸ¥è¯¢ç”¨æˆ·ä½™é¢ï¼‰
if ("balance".equals(paymentMethod)) {
    // TODO: å®é™…åº”è¯¥æŸ¥è¯¢ç”¨æˆ·ä½™é¢è¡¨
    // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå‡è®¾ä½™é¢ä¸è¶³
    logger.warn("æ”¯ä»˜è®¢å•å¤±è´¥: ä½™é¢ä¸è¶³: orderId={}, userId={}", orderId, userId);
    return Result.failure(5120); // ä½™é¢ä¸è¶³
}
```

**å»ºè®®**ï¼š
- é›†æˆæ”¯ä»˜å®ã€å¾®ä¿¡æ”¯ä»˜ç­‰ç¬¬ä¸‰æ–¹æ”¯ä»˜æ¥å£
- å®ç°ä½™é¢æ”¯ä»˜åŠŸèƒ½ï¼ˆéœ€è¦ç”¨æˆ·ä½™é¢è¡¨ï¼‰
- å®ç°æ”¯ä»˜å›è°ƒå¤„ç†

### 4. é€€æ¬¾å®é™…æ“ä½œ
**é—®é¢˜**ï¼šåŒæ„é€€æ¬¾åæ²¡æœ‰æ‰§è¡Œå®é™…çš„é€€æ¬¾æ“ä½œ

**å½“å‰å®ç°**ï¼š
```java
// TODO: è¿™é‡Œåº”è¯¥æ‰§è¡Œå®é™…çš„é€€æ¬¾æ“ä½œï¼ˆè°ƒç”¨æ”¯ä»˜æ¥å£ï¼‰
logger.info("åŒæ„é€€æ¬¾æˆåŠŸ: orderId={}, userId={}", id, userId);
```

**å»ºè®®**ï¼š
- è°ƒç”¨æ”¯ä»˜å¹³å°çš„é€€æ¬¾æ¥å£
- å¦‚æœæ˜¯ä½™é¢æ”¯ä»˜ï¼Œéœ€è¦å¢åŠ ç”¨æˆ·ä½™é¢

---

## ğŸ“Š é—®é¢˜ä¼˜å…ˆçº§

### P0ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰- å¿…é¡»ç«‹å³ä¿®å¤
1. **åº“å­˜ç®¡ç†å®Œå…¨ç¼ºå¤±** - å¯¼è‡´è¶…å–ã€åº“å­˜æ•°æ®é”™è¯¯

### P1ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰- åº”å°½å¿«ä¿®å¤
2. **é”€é‡ç»Ÿè®¡ç¼ºå¤±** - å¯¼è‡´é”€é‡æ•°æ®ä¸å‡†ç¡®
3. **å–æ¶ˆè®¢å•/é€€æ¬¾æ—¶åº“å­˜æ¢å¤ç¼ºå¤±** - å¯¼è‡´åº“å­˜æ•°æ®é”™è¯¯

### P2ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰- å»ºè®®ä¿®å¤
4. è´­ç‰©è½¦æ¸…ç©ºé€»è¾‘
5. é€šçŸ¥åŠŸèƒ½ç¼ºå¤±

### P3ï¼ˆä½ä¼˜å…ˆçº§ï¼‰- åç»­ä¼˜åŒ–
6. ç¬¬ä¸‰æ–¹æ”¯ä»˜é›†æˆ
7. å®é™…é€€æ¬¾æ“ä½œ

---

## æ€»ç»“

è®¢å•æ¨¡å—æœ€ä¸¥é‡çš„é—®é¢˜æ˜¯**åº“å­˜ç®¡ç†å®Œå…¨ç¼ºå¤±**ï¼Œè¿™ä¼šå¯¼è‡´ï¼š
1. ç”¨æˆ·å¯ä»¥æ— é™ä¸‹å•ï¼Œåº“å­˜å½¢åŒè™šè®¾
2. æ”¯ä»˜æˆåŠŸååº“å­˜ä¸å‡å°‘ï¼Œå¯¼è‡´è¶…å–
3. é”€é‡æ•°æ®å®Œå…¨ä¸å‡†ç¡®
4. å–æ¶ˆè®¢å•/é€€æ¬¾ååº“å­˜æ— æ³•æ¢å¤

è™½ç„¶æ•°æ®åº“å·²ç»æœ‰ç›¸å…³çš„SQLè¯­å¥ï¼Œä½† Mapper æ¥å£æ²¡æœ‰å£°æ˜æ–¹æ³•ï¼Œå¯¼è‡´æ— æ³•è°ƒç”¨ã€‚

**å»ºè®®ç«‹å³ä¿®å¤åº“å­˜ç®¡ç†é—®é¢˜ï¼Œè¿™æ˜¯å½±å“ä¸šåŠ¡æ­£å¸¸è¿è¡Œçš„å…³é”®ç¼ºé™·ï¼**
