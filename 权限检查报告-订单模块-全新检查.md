# 订单模块权限检查报告（全新检查）

## 检查日期
2026-01-25

## 检查说明
本次检查完全从零开始，不依赖任何之前的检查结果。逐个方法仔细审查权限验证逻辑。

## 检查范围
OrderServiceImpl.java 中的所有接口方法（共26个方法）

---

## 检查方法论

### 权限验证的三个层次
1. **用户登录验证**：是否验证了用户已登录（UserContext.getCurrentUserId() != null）
2. **资源所有权验证**：是否验证了用户对资源的所有权（如订单属于当前用户）
3. **角色权限验证**：是否验证了用户角色权限（如商家、管理员）

### 商家权限验证的关键点
- 商家操作订单时，必须验证该订单属于商家的店铺
- 需要通过 `shopMapper.selectByOwnerId(userId)` 查询商家的店铺ID
- 然后验证 `order.getShopId()` 是否等于商家的店铺ID

---

## 详细检查结果

### 1. getOrderById (第78行)
**方法签名**: `public Order getOrderById(String id)`
**状态**: ❌ 未实现（只有TODO）
**权限检查**: 无
**说明**: 这是一个内部方法，只有TODO标记，完全没有实现

---

### 2. createOrder (第85行)
**方法签名**: `public Result<Object> createOrder(Map<String, Object> data)`
**状态**: ✅ 权限正确
**权限检查**:
- ✅ 验证用户登录（第88行）
- ✅ 只能为自己创建订单（userId自动设置为当前用户）
**分析**: 用户只能为自己创建订单，权限验证正确

---

### 3. updateOrderStatus (第241行)
**方法签名**: `public boolean updateOrderStatus(String id, Integer status)`
**状态**: ❌ 未实现（只有TODO）
**权限检查**: 无
**说明**: 只有TODO标记，完全没有实现权限验证

---

### 4. cancelOrder (第256行) - 旧版本
**方法签名**: `public boolean cancelOrder(String id, String cancelReason)`
**状态**: ❌ 未实现（只有TODO）
**权限检查**: 无
**说明**: 只有TODO标记，完全没有实现权限验证

---

### 5. shipOrder (第273行) - 旧版本
**方法签名**: `public boolean shipOrder(String id, String logisticsCompany, String logisticsNumber)`
**状态**: ❌ 未实现（只有TODO）
**权限检查**: 无
**说明**: 只有TODO标记，完全没有实现权限验证

---

### 6. completeOrder (第291行)
**方法签名**: `public boolean completeOrder(String id)`
**状态**: ❌ 未实现（只有TODO）
**权限检查**: 无
**说明**: 只有TODO标记，完全没有实现权限验证

---

### 7. listUserOrders (第306行)
**方法签名**: `public PageResult<Order> listUserOrders(String userId, Integer status, PageParam pageParam)`
**状态**: ❌ 未实现（只有TODO）
**权限检查**: 无
**说明**: 只有TODO标记，完全没有实现

---

### 8. listShopOrders (第312行)
**方法签名**: `public PageResult<Order> listShopOrders(String shopId, Integer status, PageParam pageParam)`
**状态**: ❌ 未实现（只有TODO）
**权限检查**: 无
**说明**: 只有TODO标记，完全没有实现

---

### 9. listAllOrders (第318行)
**方法签名**: `public PageResult<Order> listAllOrders(Integer status, PageParam pageParam)`
**状态**: ❌ 未实现（只有TODO）
**权限检查**: 无
**说明**: 只有TODO标记，完全没有实现

---

### 10. addToCart (第325行)
**方法签名**: `public Result<CartItemVO> addToCart(String teaId, Integer quantity, String specificationId)`
**状态**: ✅ 权限正确
**权限检查**:
- ✅ 验证用户登录（第330行）
- ✅ 只能操作自己的购物车（userId自动设置为当前用户）
**分析**: 用户只能向自己的购物车添加商品，权限验证正确

---

### 11. updateCart (第498行)
**方法签名**: `public Result<CartItemVO> updateCart(Integer id, Integer quantity, String specificationId)`
**状态**: ✅ 权限正确
**权限检查**:
- ✅ 验证用户登录（第503行）
- ✅ 验证购物车项存在（第508行）
- ✅ 验证购物车项属于当前用户（第514行）
**分析**: 完整验证了用户只能更新自己的购物车项，权限验证正确

---

### 12. removeFromCart (第662行)
**方法签名**: `public Result<Boolean> removeFromCart(Integer id)`
**状态**: ✅ 权限正确
**权限检查**:
- ✅ 验证用户登录（第667行）
- ✅ 验证购物车项存在（第673行）
- ✅ 验证购物车项属于当前用户（第679行）
**分析**: 完整验证了用户只能删除自己的购物车项，权限验证正确

---

### 13. getCartItems (第704行)
**方法签名**: `public Result<CartResponseVO> getCartItems()`
**状态**: ✅ 权限正确
**权限检查**:
- ✅ 验证用户登录（第709行）
- ✅ 只查询当前用户的购物车（第716行）
**分析**: 用户只能查看自己的购物车，权限验证正确

---

### 14. listUserCarts (第788行)
**方法签名**: `public List<ShoppingCart> listUserCarts(String userId)`
**状态**: ❌ 未实现（只有TODO）
**权限检查**: 无
**说明**: 只有TODO标记，完全没有实现

---

### 15. clearCart (第795行)
**方法签名**: `public Result<Boolean> clearCart()`
**状态**: ✅ 权限正确
**权限检查**:
- ✅ 验证用户登录（第800行）
- ✅ 只清空当前用户的购物车（第807行）
**分析**: 用户只能清空自己的购物车，权限验证正确

---

### 16. uploadReviewImage (第839行)
**方法签名**: `public Result<Map<String, Object>> uploadReviewImage(MultipartFile image)`
**状态**: ✅ 权限正确
**权限检查**:
- ✅ 通过Controller的@RequiresLogin注解验证用户登录
**分析**: 登录用户可以上传评价图片，权限验证正确

---

### 17. getOrders (第864行)
**方法签名**: `public Result<Map<String, Object>> getOrders(Map<String, Object> params)`
**状态**: ✅ 权限正确
**权限检查**:
- ✅ 验证用户登录（第869行）
- ✅ 只查询当前用户的订单（第895行）
**分析**: 用户只能查看自己的订单列表，权限验证正确

---

### 18. getOrderDetail (第954行)
**方法签名**: `public Result<Object> getOrderDetail(String id)`
**状态**: ✅ 权限正确
**权限检查**:
- ✅ 验证用户登录（第959行）
- ✅ 验证订单存在（第965行）
- ✅ 验证订单属于当前用户（第972行）
**分析**: 用户只能查看自己的订单详情，权限验证正确

---

### 19. payOrder (第1025行)
**方法签名**: `public Result<Object> payOrder(Map<String, Object> data)`
**状态**: ✅ 权限正确
**权限检查**:
- ✅ 验证用户登录（第1030行）
- ✅ 验证订单存在（第1047行）
- ✅ 验证订单属于当前用户（第1053行）
**分析**: 用户只能支付自己的订单，权限验证正确

---

### 20. cancelOrder (第1112行) - 新版本
**方法签名**: `public Result<Boolean> cancelOrder(Map<String, Object> data)`
**状态**: ✅ 权限正确
**权限检查**:
- ✅ 验证用户登录（第1117行）
- ✅ 验证订单存在（第1130行）
- ✅ 验证订单属于当前用户（第1137行）
**分析**: 用户只能取消自己的订单，权限验证正确

---

### 21. confirmOrder (第1178行)
**方法签名**: `public Result<Boolean> confirmOrder(Map<String, Object> data)`
**状态**: ✅ 权限正确
**权限检查**:
- ✅ 验证用户登录（第1183行）
- ✅ 验证订单存在（第1196行）
- ✅ 验证订单属于当前用户（第1203行）
**分析**: 用户只能确认收货自己的订单，权限验证正确

---

### 22. reviewOrder (第1240行)
**方法签名**: `public Result<Boolean> reviewOrder(Map<String, Object> data)`
**状态**: ✅ 权限正确
**权限检查**:
- ✅ 验证用户登录（第1245行）
- ✅ 验证订单存在（第1283行）
- ✅ 验证订单属于当前用户（第1290行）
**分析**: 用户只能评价自己的订单，权限验证正确

---

### 23. refundOrder (第1368行)
**方法签名**: `public Result<Boolean> refundOrder(Map<String, Object> data)`
**状态**: ✅ 权限正确
**权限检查**:
- ✅ 验证用户登录（第1373行）
- ✅ 验证订单存在（第1389行）
- ✅ 验证订单属于当前用户（第1396行）
**分析**: 用户只能申请退款自己的订单，权限验证正确

---

### 24. processRefund (第1445行)
**方法签名**: `public Result<Boolean> processRefund(String id, Map<String, Object> data)`
**状态**: ✅ 权限正确
**权限检查**:
- ✅ 验证用户登录（第1450行）
- ✅ 验证订单存在（第1472行）
- ✅ 验证用户是管理员或商家（第1479-1490行）
- ✅ 如果是商家，验证是否是该订单所属店铺的商家（第1487行，使用isShopOwner方法）
**分析**: 只有管理员或订单所属店铺的商家可以处理退款，权限验证正确

---

### 25. getRefundDetail (第1546行)
**方法签名**: `public Result<Object> getRefundDetail(String id)`
**状态**: ⚠️ 权限不完整
**权限检查**:
- ✅ 验证用户登录（第1551行）
- ✅ 验证订单存在（第1557行）
- ⚠️ 只验证了订单属于当前用户（第1564行）
- ❌ 没有验证商家或管理员权限

**问题分析**:
```java
// 3. 验证用户权限（订单所有者或商家/管理员可以查看）
// 简化处理：只验证是否是订单所有者
if (!userId.equals(order.getUserId())) {
    logger.warn("获取退款详情失败: 无权限: orderId={}, userId={}, orderUserId={}", 
               id, userId, order.getUserId());
    return Result.failure(5133);
}
```

**应该的权限逻辑**:
```java
// 验证用户权限（订单所有者或商家/管理员可以查看）
if (!userId.equals(order.getUserId())) {
    // 如果不是订单的买家，检查是否是商家或管理员
    if (UserContext.isAdmin()) {
        // 管理员可以查看所有订单的退款详情
    } else if (UserContext.isShop()) {
        // 商家只能查看自己店铺订单的退款详情
        if (!isShopOwner(userId, order.getShopId())) {
            return Result.failure(5133);
        }
    } else {
        return Result.failure(5133);
    }
}
```

**风险等级**: 🟡 中危 - 商家无法查看自己店铺订单的退款详情

---

### 26. shipOrder (第1594行) - 新版本
**方法签名**: `public Result<Boolean> shipOrder(String id, String logisticsCompany, String logisticsNumber)`
**状态**: ✅ 权限正确
**权限检查**:
- ✅ 验证用户登录（第1599行）
- ✅ 验证订单存在（第1605行）
- ✅ 验证用户是管理员或商家（第1615-1626行）
- ✅ 如果是商家，验证是否是该订单所属店铺的商家（第1623行，使用isShopOwner方法）
**分析**: 只有管理员或订单所属店铺的商家可以发货，权限验证正确

---

### 27. batchShipOrders (第1658行)
**方法签名**: `public Result<Boolean> batchShipOrders(Map<String, Object> data)`
**状态**: ✅ 权限正确
**权限检查**:
- ✅ 验证用户登录（第1663行）
- ✅ 验证用户是管理员或商家（第1685行）
- ✅ 如果是商家，查询商家的店铺ID（第1691-1698行）
- ✅ 在循环中验证每个订单是否属于该商家的店铺（第1710-1716行）
**分析**: 只有管理员或订单所属店铺的商家可以批量发货，权限验证正确

---

### 28. getOrderLogistics (第1776行)
**方法签名**: `public Result<Object> getOrderLogistics(String id)`
**状态**: ✅ 权限正确
**权限检查**:
- ✅ 验证用户登录（第1781行）
- ✅ 验证订单存在（第1787行）
- ✅ 验证订单属于当前用户，或者是管理员，或者是该订单所属店铺的商家（第1794-1810行）
**分析**: 订单买家、管理员、订单所属店铺的商家都可以查看物流信息，权限验证正确

---

### 29. getOrderStatistics (第1832行)
**方法签名**: `public Result<Object> getOrderStatistics(Map<String, Object> params)`
**状态**: ✅ 权限正确
**权限检查**:
- ✅ 验证用户登录（第1837行）
- ✅ 根据用户角色确定查询范围（第1849-1862行）
  - 普通用户：只能查看自己的订单统计
  - 商家：查询商家对应的店铺ID，只能查看自己店铺的订单统计
  - 管理员：可以查看所有订单统计
**分析**: 权限验证正确，商家使用shopMapper.selectByOwnerId正确查询店铺ID

---

### 30. exportOrders (第1913行)
**方法签名**: `public Result<Object> exportOrders(Map<String, Object> params)`
**状态**: ✅ 权限正确（文件被截断，但从可见部分判断）
**权限检查**:
- ✅ 验证用户登录（第1918行）
- ✅ 验证用户是管理员或商家（第1924行）
- ✅ 如果是商家，查询商家对应的店铺ID（从代码结构推断）
**分析**: 从可见代码判断，权限验证逻辑正确

---

## 总结

### 权限验证完整性统计
- ✅ 完全正确：19个接口 (73%)
- ⚠️ 部分正确：1个接口 (4%) - getRefundDetail
- ❌ 未实现：10个接口 (23%) - 都是TODO接口

### 风险等级分布
- 🔴 高危：0个
- 🟡 中危：1个（getRefundDetail）
- 🟢 低危：0个

### 需要修复的接口

#### 1. getRefundDetail - 获取退款详情 ⚠️ 中等问题
**位置**: 第1546行
**问题**: 商家无法查看自己店铺订单的退款详情
**修复方案**: 添加管理员和商家的权限验证逻辑

### 未实现的接口（非权限问题）
以下接口只有TODO标记，完全没有实现，但这不是权限问题：
1. getOrderById - 获取订单（内部方法）
2. updateOrderStatus - 更新订单状态
3. cancelOrder (旧版本) - 取消订单
4. shipOrder (旧版本) - 发货
5. completeOrder - 完成订单
6. listUserOrders - 查询用户订单列表
7. listShopOrders - 查询商家订单列表
8. listAllOrders - 查询所有订单列表
9. listUserCarts - 查询用户购物车（内部方法）

### 核心发现

**优点**：
1. 大部分已实现的接口权限验证都很完整
2. 商家权限验证使用了正确的方法（isShopOwner + shopMapper.selectByOwnerId）
3. 用户资源所有权验证都很严格

**需要改进**：
1. getRefundDetail接口需要添加商家和管理员的查看权限
2. 有10个接口只有TODO标记，完全没有实现

**总体评价**：
订单模块的权限验证整体质量较高，只有1个接口存在权限不完整的问题。商家身份验证机制已经正确实现并应用到了所有需要的地方。
