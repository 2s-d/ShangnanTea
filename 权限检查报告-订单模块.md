# 订单模块权限检查报告

## 检查日期
2026-01-25

## 检查范围
OrderServiceImpl.java 中的所有接口方法

---

## 权限检查结果汇总

### ✅ 权限验证正确的接口（15个）

1. **createOrder** - 创建订单
   - ✅ 验证用户登录
   - ✅ 只能为自己创建订单

2. **addToCart** - 加入购物车
   - ✅ 验证用户登录
   - ✅ 只能操作自己的购物车

3. **updateCart** - 更新购物车
   - ✅ 验证用户登录
   - ✅ 验证购物车项属于当前用户

4. **removeFromCart** - 移除购物车商品
   - ✅ 验证用户登录
   - ✅ 验证购物车项属于当前用户

5. **getCartItems** - 获取购物车
   - ✅ 验证用户登录
   - ✅ 只返回当前用户的购物车

6. **clearCart** - 清空购物车
   - ✅ 验证用户登录
   - ✅ 只清空当前用户的购物车

7. **getOrders** - 获取订单列表
   - ✅ 验证用户登录
   - ✅ 只返回当前用户的订单

8. **getOrderDetail** - 获取订单详情
   - ✅ 验证用户登录
   - ✅ 验证订单属于当前用户

9. **payOrder** - 订单支付
   - ✅ 验证用户登录
   - ✅ 验证订单属于当前用户

10. **cancelOrder** - 取消订单
    - ✅ 验证用户登录
    - ✅ 验证订单属于当前用户

11. **confirmOrder** - 确认收货
    - ✅ 验证用户登录
    - ✅ 验证订单属于当前用户

12. **reviewOrder** - 评价订单
    - ✅ 验证用户登录
    - ✅ 验证订单属于当前用户

13. **refundOrder** - 申请退款
    - ✅ 验证用户登录
    - ✅ 验证订单属于当前用户

14. **getRefundDetail** - 获取退款详情
    - ✅ 验证用户登录
    - ✅ 验证订单属于当前用户

15. **uploadReviewImage** - 上传评价图片
    - ✅ 验证用户登录（通过Controller的@RequiresLogin）

---

### ⚠️ 权限验证不完整的接口（4个）

#### 1. **processRefund** - 处理退款申请 ⚠️ 严重问题
**位置**: OrderServiceImpl.java 第1414行

**当前状态**:
```java
// 4. 验证权限（需要是商家或管理员）
// TODO: 这里应该验证当前用户是否是该订单所属店铺的商家或管理员
// 暂时简化处理，只要登录就可以处理（实际应该检查shopId和用户关系）
```

**问题**:
- ❌ 只验证了用户登录
- ❌ 没有验证用户是否是商家或管理员
- ❌ 任何登录用户都可以处理任何订单的退款

**应该的权限逻辑**:
```java
// 验证权限：只有管理员或订单所属店铺的商家可以处理退款
if (!UserContext.isAdmin()) {
    // 如果不是管理员，必须是该订单所属店铺的商家
    if (!UserContext.isShop()) {
        logger.warn("处理退款失败: 权限不足, userId={}", userId);
        return Result.failure(5132); // 权限不足
    }
    
    // 验证是否是该订单所属店铺的商家
    // 需要查询shop表，验证userId对应的shopId是否等于order.getShopId()
    // TODO: 需要添加ShopMapper依赖并查询
}
```

**风险等级**: 🔴 高危 - 任何用户都可以同意/拒绝退款

---

#### 2. **shipOrder** - 发货 ⚠️ 严重问题
**位置**: OrderServiceImpl.java 第1552行

**当前状态**:
```java
// 验证权限：只有管理员和商家可以发货
if (!UserContext.isAdmin() && !UserContext.isShop()) {
    logger.warn("发货失败: 权限不足, userId={}", userId);
    return Result.failure(5137); // 权限不足
}
```

**问题**:
- ✅ 验证了用户是管理员或商家
- ❌ 但没有验证商家是否是该订单所属店铺的商家
- ❌ 任何商家都可以给任何订单发货

**应该的权限逻辑**:
```java
// 验证权限：只有管理员或订单所属店铺的商家可以发货
if (!UserContext.isAdmin()) {
    if (!UserContext.isShop()) {
        logger.warn("发货失败: 权限不足, userId={}", userId);
        return Result.failure(5137);
    }
    
    // 验证是否是该订单所属店铺的商家
    // 需要查询shop表，验证userId对应的shopId是否等于order.getShopId()
}
```

**风险等级**: 🔴 高危 - 商家可以给其他店铺的订单发货

---

#### 3. **batchShipOrders** - 批量发货 ⚠️ 严重问题
**位置**: OrderServiceImpl.java 第1608行

**当前状态**:
```java
// 验证权限：只有管理员和商家可以批量发货
if (!UserContext.isAdmin() && !UserContext.isShop()) {
    logger.warn("批量发货失败: 权限不足, userId={}", userId);
    return Result.failure(5139); // 权限不足
}
```

**问题**:
- ✅ 验证了用户是管理员或商家
- ❌ 但没有验证商家是否是这些订单所属店铺的商家
- ❌ 任何商家都可以给任何订单批量发货

**应该的权限逻辑**:
```java
// 验证权限：只有管理员或订单所属店铺的商家可以批量发货
if (!UserContext.isAdmin()) {
    if (!UserContext.isShop()) {
        logger.warn("批量发货失败: 权限不足, userId={}", userId);
        return Result.failure(5139);
    }
    
    // 对于每个订单，验证是否是该订单所属店铺的商家
    // 需要查询shop表，验证userId对应的shopId
    // 然后验证所有订单的shopId是否都等于该商家的shopId
}
```

**风险等级**: 🔴 高危 - 商家可以给其他店铺的订单批量发货

---

#### 4. **getOrderLogistics** - 获取物流信息 ⚠️ 中等问题
**位置**: OrderServiceImpl.java 第1705行

**当前状态**:
```java
// 1. 获取当前用户ID
String userId = UserContext.getCurrentUserId();
if (userId == null) {
    logger.warn("获取物流信息失败: 用户未登录");
    return Result.failure(5140);
}

// 2. 查询订单
Order order = orderMapper.selectById(id);
if (order == null) {
    logger.warn("获取物流信息失败: 订单不存在: orderId={}", id);
    return Result.failure(5140);
}

// 3. 验证订单是否属于当前用户或商家
// 用户只能查看自己的订单物流，商家可以查看自己店铺的订单物流
if (!userId.equals(order.getUserId())) {
    // 如果不是订单的买家，检查是否是商家
    if (!UserContext.isShop()) {
        logger.warn("获取物流信息失败: 权限不足, userId={}, orderUserId={}", userId, order.getUserId());
        return Result.failure(5141); // 权限不足
    }
    
    // TODO: 验证商家是否是该订单所属店铺的商家
    // 暂时简化处理，只要是商家就可以查看
}
```

**问题**:
- ✅ 验证了用户登录
- ✅ 验证了订单属于当前用户
- ✅ 验证了用户是商家
- ❌ 但没有验证商家是否是该订单所属店铺的商家
- ❌ 任何商家都可以查看任何订单的物流信息

**应该的权限逻辑**:
```java
// 验证订单是否属于当前用户或商家
if (!userId.equals(order.getUserId())) {
    // 如果不是订单的买家，检查是否是商家
    if (!UserContext.isShop()) {
        logger.warn("获取物流信息失败: 权限不足, userId={}, orderUserId={}", userId, order.getUserId());
        return Result.failure(5141);
    }
    
    // 验证商家是否是该订单所属店铺的商家
    // 需要查询shop表，验证userId对应的shopId是否等于order.getShopId()
}
```

**风险等级**: 🟡 中危 - 商家可以查看其他店铺订单的物流信息

---

### ❌ 未实现的接口（3个）

这些接口只有TODO标记，完全没有实现：

1. **getOrderById** - 获取订单（内部方法）
   - 位置：第74行
   - 状态：只有TODO注释

2. **listUserOrders** - 查询用户订单列表
   - 位置：第302行
   - 状态：只有TODO注释

3. **listShopOrders** - 查询商家订单列表
   - 位置：第308行
   - 状态：只有TODO注释

4. **listAllOrders** - 查询所有订单列表
   - 位置：第314行
   - 状态：只有TODO注释

5. **listUserCarts** - 查询用户购物车（内部方法）
   - 位置：第758行
   - 状态：只有TODO注释

---

## 修复建议

### 1. 立即修复（高危）

需要添加ShopMapper依赖，并实现商家身份验证：

```java
// 在OrderServiceImpl中添加
@Autowired
private ShopMapper shopMapper;

// 创建辅助方法验证商家权限
private boolean isShopOwner(String userId, String shopId) {
    if (shopId == null || shopId.isEmpty()) {
        return false;
    }
    
    // 查询该用户对应的店铺
    Shop shop = shopMapper.selectByUserId(userId);
    if (shop == null) {
        return false;
    }
    
    // 验证店铺ID是否匹配
    return shopId.equals(shop.getId());
}
```

然后在以下接口中使用：
- processRefund
- shipOrder
- batchShipOrders
- getOrderLogistics

### 2. 统计数据接口的权限问题

**getOrderStatistics** 和 **exportOrders** 中有TODO：
```java
// TODO: 从shop表查询当前用户对应的店铺ID
// 暂时使用userId作为shopId（假设userId和shopId关联）
```

这个假设是错误的，需要修复。

---

## 总结

### 权限验证完整性统计
- ✅ 完全正确：15个接口 (71%)
- ⚠️ 部分正确：4个接口 (19%)
- ❌ 未实现：5个接口 (10%)

### 风险等级分布
- 🔴 高危：3个（processRefund, shipOrder, batchShipOrders）
- 🟡 中危：1个（getOrderLogistics）
- 🟢 低危：0个

### 核心问题
**缺少商家身份验证机制**：
- 没有ShopMapper依赖
- 没有验证商家是否拥有该店铺
- 导致任何商家都可以操作任何店铺的订单

### 下一步行动
1. 添加ShopMapper依赖
2. 实现isShopOwner辅助方法
3. 修复4个权限不完整的接口
4. 实现5个未完成的接口
